{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/payments/p2tr.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/payments/p2tr.ts"],"names":[],"mappings":"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","sourcesContent":["// SegWit version 1 P2TR output type for Taproot defined in\n// https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki\n\nimport { networks } from '../networks';\nimport { script as bscript, Payment, PaymentOpts, lazy } from 'bitcoinjs-lib';\nimport * as taproot from '../taproot';\nimport { musig } from '../noble_ecc';\nimport * as necc from '@noble/secp256k1';\n\nconst typef = require('typeforce');\nconst OPS = bscript.OPS;\n\nconst { bech32m } = require('bech32');\n\nconst BITCOIN_NETWORK = networks.bitcoin;\n\n/**\n * A secp256k1 x coordinate with unknown discrete logarithm used for eliminating\n * keypath spends, equal to SHA256(uncompressedDER(SECP256K1_GENERATOR_POINT)).\n */\nconst H = Buffer.from('50929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0', 'hex');\nconst EMPTY_BUFFER = Buffer.alloc(0);\n\nfunction isPlainPubkey(pubKey: Uint8Array): boolean {\n  if (pubKey.length !== 33) return false;\n  try {\n    return !!necc.Point.fromHex(pubKey);\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction isPlainPubkeys(pubkeys: Buffer[]) {\n  return pubkeys.every(isPlainPubkey);\n}\n\n// output: OP_1 {witnessProgram}\nexport function p2tr(a: Payment, opts?: PaymentOpts): Payment {\n  if (!a.address && !a.pubkey && !a.pubkeys && !(a.redeems && a.redeems.length) && !a.output && !a.witness) {\n    throw new TypeError('Not enough data');\n  }\n  opts = Object.assign({ validate: true }, opts || {});\n\n  if (!opts.eccLib) throw new Error('ECC Library is required for p2tr.');\n  const ecc = opts.eccLib;\n\n  typef(\n    {\n      network: typef.maybe(typef.Object),\n\n      address: typef.maybe(typef.String),\n      // the output script should be a fixed 34 bytes.\n      // 1 byte for OP_1 indicating segwit version 1, one byte for 0x20 to push\n      // the next 32 bytes, followed by the 32 byte witness program\n      output: typef.maybe(typef.BufferN(34)),\n      // a single pubkey\n      pubkey: typef.maybe(ecc.isXOnlyPoint),\n      // the pub key(s) used for keypath signing.\n      // aggregated with MuSig2* if > 1\n      pubkeys: typef.maybe(typef.anyOf(typef.arrayOf(ecc.isXOnlyPoint), typef.arrayOf(isPlainPubkey))),\n\n      redeems: typef.maybe(\n        typef.arrayOf({\n          network: typef.maybe(typef.Object),\n          output: typef.maybe(typef.Buffer),\n          weight: typef.maybe(typef.Number),\n          depth: typef.maybe(typef.Number),\n          witness: typef.maybe(typef.arrayOf(typef.Buffer)),\n        })\n      ),\n      redeemIndex: typef.maybe(typef.Number), // Selects the redeem to spend\n\n      signature: typef.maybe(bscript.isCanonicalSchnorrSignature),\n      controlBlock: typef.maybe(typef.Buffer),\n      annex: typef.maybe(typef.Buffer),\n    },\n    a\n  );\n\n  const _address = lazy.value(() => {\n    if (!a.address) return undefined;\n\n    const result = bech32m.decode(a.address);\n    const version = result.words.shift();\n    const data = bech32m.fromWords(result.words);\n    return {\n      version,\n      prefix: result.prefix,\n      data: Buffer.from(data),\n    };\n  });\n  const _outputPubkey = lazy.value(() => {\n    // we remove the first two bytes (OP_1 0x20) from the output script to\n    // extract the 32 byte taproot pubkey (aka witness program)\n    return a.output && a.output.slice(2);\n  });\n\n  const network = a.network || BITCOIN_NETWORK;\n\n  const o: Payment = { network };\n\n  const _taprootPaths = lazy.value(() => {\n    if (!a.redeems) return;\n    if (o.tapTree) {\n      return taproot.getDepthFirstTaptree(o.tapTree);\n    }\n    const outputs: Array<Buffer | undefined> = a.redeems.map(({ output }) => output);\n    if (!outputs.every((output) => output)) return;\n    return taproot.getHuffmanTaptree(\n      outputs as Buffer[],\n      a.redeems.map(({ weight }) => weight)\n    );\n  });\n  const _parsedWitness = lazy.value(() => {\n    if (!a.witness) return;\n    return taproot.parseTaprootWitness(a.witness);\n  });\n  const _parsedControlBlock = lazy.value(() => {\n    // Can't use o.controlBlock, because it could be circular\n    if (a.controlBlock) return taproot.parseControlBlock(ecc, a.controlBlock);\n    const parsedWitness = _parsedWitness();\n    if (parsedWitness && parsedWitness.spendType === 'Script') {\n      return taproot.parseControlBlock(ecc, parsedWitness.controlBlock);\n    }\n  });\n\n  lazy.prop(o, 'internalPubkey', () => {\n    if (a.pubkey) {\n      // single pubkey\n      return a.pubkey;\n    } else if (a.pubkeys && a.pubkeys.length === 1) {\n      return a.pubkeys[0];\n    } else if (a.pubkeys && a.pubkeys.length > 1) {\n      // multiple pubkeys\n      if (isPlainPubkeys(a.pubkeys)) {\n        return Buffer.from(musig.getXOnlyPubkey(musig.keyAgg(a.pubkeys)));\n      }\n\n      return Buffer.from(taproot.aggregateMuSigPubkeys(ecc, a.pubkeys));\n    } else if (_parsedControlBlock()) {\n      return _parsedControlBlock()?.internalPubkey;\n    } else {\n      // If there is no key path spending condition, we use an internal key with unknown secret key.\n      // TODO: In order to avoid leaking the information that key path spending is not possible it\n      // is recommended to pick a fresh integer r in the range 0...n-1 uniformly at random and use\n      // H + rG as internal key. It is possible to prove that this internal key does not have a\n      // known discrete logarithm with respect to G by revealing r to a verifier who can then\n      // reconstruct how the internal key was created.\n      return H;\n    }\n  });\n\n  lazy.prop(o, 'taptreeRoot', () => {\n    const parsedControlBlock = _parsedControlBlock();\n    const parsedWitness = _parsedWitness();\n    let taptreeRoot;\n    // Prefer to get the root via the control block because not all redeems may\n    // be available\n    if (parsedControlBlock) {\n      let tapscript;\n      if (parsedWitness && parsedWitness.spendType === 'Script') {\n        tapscript = parsedWitness.tapscript;\n      } else if (o.redeem && o.redeem.output) {\n        tapscript = o.redeem.output;\n      }\n      if (tapscript) taptreeRoot = taproot.getTaptreeRoot(ecc, parsedControlBlock, tapscript);\n    }\n    if (!taptreeRoot && _taprootPaths()) taptreeRoot = _taprootPaths()?.root;\n\n    return taptreeRoot;\n  });\n\n  const _taprootPubkey = lazy.value(() => {\n    const taptreeRoot = o.taptreeRoot;\n    // Refuse to create an unspendable key\n    if (!a.pubkey && !(a.pubkeys && a.pubkeys.length) && !a.redeems && !taptreeRoot) {\n      return;\n    }\n    return taproot.tapTweakPubkey(ecc, o?.internalPubkey as Uint8Array, taptreeRoot);\n  });\n\n  lazy.prop(o, 'tapTree', () => {\n    if (!a.redeems) return;\n    if (a.redeems.find(({ depth }) => depth === undefined)) {\n      console.warn(\n        'Deprecation Warning: Weight-based tap tree construction will be removed in the future. ' +\n          'Please use depth-first coding as specified in BIP-0371.'\n      );\n      return;\n    }\n    if (!a.redeems.every(({ output }) => output)) return;\n    return {\n      leaves: a.redeems.map(({ output, depth }) => {\n        return {\n          script: output,\n          leafVersion: taproot.INITIAL_TAPSCRIPT_VERSION,\n          depth,\n        };\n      }),\n    };\n  });\n  lazy.prop(o, 'address', () => {\n    const pubkey = _outputPubkey() || (_taprootPubkey() && _taprootPubkey()?.xOnlyPubkey);\n    // only encode the 32 byte witness program as bech32m\n    const words = bech32m.toWords(pubkey);\n    words.unshift(0x01);\n    return bech32m.encode(network.bech32, words);\n  });\n  lazy.prop(o, 'controlBlock', () => {\n    const parsedWitness = _parsedWitness();\n    if (parsedWitness && parsedWitness.spendType === 'Script') {\n      return parsedWitness.controlBlock;\n    }\n    const taprootPubkey = _taprootPubkey();\n    const taprootPaths = _taprootPaths();\n    if (!taprootPaths || !taprootPubkey || a.redeemIndex === undefined) return;\n    return taproot.getControlBlock(taprootPubkey.parity, o.internalPubkey!, taprootPaths.paths[a.redeemIndex]);\n  });\n  lazy.prop(o, 'signature', () => {\n    const parsedWitness = _parsedWitness();\n    if (parsedWitness && parsedWitness.spendType === 'Key') {\n      return parsedWitness.signature;\n    }\n  });\n  lazy.prop(o, 'annex', () => {\n    if (!_parsedWitness()) return;\n    return _parsedWitness()!.annex;\n  });\n  lazy.prop(o, 'output', () => {\n    if (a.address) {\n      const { data } = _address()!;\n      return bscript.compile([OPS.OP_1, data]);\n    }\n\n    const taprootPubkey = _taprootPubkey();\n    if (!taprootPubkey) return;\n\n    // OP_1 indicates segwit version 1\n    return bscript.compile([OPS.OP_1, Buffer.from(taprootPubkey.xOnlyPubkey)]);\n  });\n  lazy.prop(o, 'witness', () => {\n    if (!a.redeems) {\n      if (a.signature) return [a.signature]; // Keypath spend\n      return;\n    } else if (!o.redeem) {\n      return; // No chosen redeem script, can't make witness\n    } else if (!o.controlBlock) {\n      return;\n    }\n\n    let redeemWitness;\n    // some callers may provide witness elements in the input script\n    if (o.redeem.input && o.redeem.input.length > 0 && o.redeem.output && o.redeem.output.length > 0) {\n      // transform redeem input to witness stack\n      redeemWitness = bscript.toStack(bscript.decompile(o.redeem.input)!);\n\n      // assigns a new object to o.redeem\n      o.redeems![a.redeemIndex!] = Object.assign({ witness: redeemWitness }, o.redeem);\n      o.redeem.input = EMPTY_BUFFER;\n    } else if (o.redeem.output && o.redeem.output.length > 0 && o.redeem.witness && o.redeem.witness.length > 0) {\n      redeemWitness = o.redeem.witness;\n    } else {\n      return;\n    }\n\n    const witness = [...redeemWitness, o.redeem.output, o.controlBlock];\n\n    if (a.annex) {\n      witness.push(a.annex);\n    }\n\n    return witness;\n  });\n  lazy.prop(o, 'name', () => {\n    const nameParts = ['p2tr'];\n    return nameParts.join('-');\n  });\n  lazy.prop(o, 'redeem', () => {\n    if (a.redeems) {\n      if (a.redeemIndex === undefined) return;\n      return a.redeems[a.redeemIndex];\n    }\n    const parsedWitness = _parsedWitness();\n    if (parsedWitness && parsedWitness.spendType === 'Script') {\n      return {\n        witness: parsedWitness.scriptSig,\n        output: parsedWitness.tapscript,\n      };\n    }\n  });\n\n  // extended validation\n  if (opts.validate) {\n    const taprootPubkey = _taprootPubkey();\n\n    if (a.output) {\n      if (a.output[0] !== OPS.OP_1 || a.output[1] !== 0x20) {\n        throw new TypeError('Output is invalid');\n      }\n\n      // if we're passed both an output script and an address, ensure they match\n      if (a.address && _outputPubkey && !_outputPubkey()?.equals(_address()?.data as Buffer)) {\n        throw new TypeError('mismatch between address & output');\n      }\n\n      // Wrapping `taprootPubkey.xOnlyPubkey` in Buffer because of a peculiar issue in the frontend\n      // where a polyfill for Buffer is used. Refer: https://bitgoinc.atlassian.net/browse/BG-61420\n      if (taprootPubkey && _outputPubkey && !_outputPubkey()?.equals(Buffer.from(taprootPubkey.xOnlyPubkey))) {\n        throw new TypeError('mismatch between output and taproot pubkey');\n      }\n    }\n\n    if (a.address) {\n      if (taprootPubkey && !_address()?.data.equals(Buffer.from(taprootPubkey.xOnlyPubkey))) {\n        throw new TypeError('mismatch between address and taproot pubkey');\n      }\n    }\n\n    const parsedControlBlock = _parsedControlBlock();\n    if (parsedControlBlock) {\n      if (!parsedControlBlock.internalPubkey.equals(o?.internalPubkey as Uint8Array)) {\n        throw new TypeError('Internal pubkey mismatch');\n      }\n      if (taprootPubkey && parsedControlBlock.parity !== taprootPubkey.parity) {\n        throw new TypeError('Parity mismatch');\n      }\n    }\n\n    if (a.redeems) {\n      if (!a.redeems.length) throw new TypeError('Empty redeems');\n      if (a.redeemIndex !== undefined && (a.redeemIndex < 0 || a.redeemIndex >= a.redeems.length)) {\n        throw new TypeError('invalid redeem index');\n      }\n      a.redeems.forEach((redeem) => {\n        if (redeem.network && redeem.network !== network) {\n          throw new TypeError('Network mismatch');\n        }\n      });\n    }\n\n    const chosenRedeem = a.redeems && a.redeemIndex !== undefined && a.redeems[a.redeemIndex];\n\n    const parsedWitness = _parsedWitness();\n    if (parsedWitness && parsedWitness.spendType === 'Key') {\n      if (a.controlBlock) {\n        throw new TypeError('unexpected control block for key path');\n      }\n\n      if (a.signature && !a.signature.equals(parsedWitness.signature)) {\n        throw new TypeError('mismatch between witness & signature');\n      }\n    }\n    if (parsedWitness && parsedWitness.spendType === 'Script') {\n      if (a.signature) {\n        throw new TypeError('unexpected signature with script path witness');\n      }\n\n      if (a.controlBlock && !a.controlBlock.equals(parsedWitness.controlBlock)) {\n        throw new TypeError('control block mismatch');\n      }\n\n      if (a.annex && parsedWitness.annex && !a.annex.equals(parsedWitness.annex)) {\n        throw new TypeError('annex mismatch');\n      }\n\n      if (chosenRedeem && chosenRedeem.output && !chosenRedeem.output.equals(parsedWitness.tapscript)) {\n        throw new TypeError('tapscript mismatch');\n      }\n    }\n  }\n\n  return Object.assign(o, a);\n}\n"]}
{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/testutil/transaction.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/testutil/transaction.ts"],"names":[],"mappings":"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","sourcesContent":["import * as assert from 'assert';\n\nimport { ScriptType, ScriptType2Of3, scriptTypeP2shP2pk, scriptTypes2Of3 } from '../bitgo/outputScripts';\nimport {\n  getExternalChainCode,\n  isWalletUnspent,\n  KeyName,\n  getInternalChainCode,\n  RootWalletKeys,\n  Unspent,\n  UtxoTransactionBuilder,\n  createTransactionBuilderForNetwork,\n  addToTransactionBuilder,\n  getWalletAddress,\n  signInputP2shP2pk,\n  signInputWithUnspent,\n  WalletUnspentSigner,\n} from '../bitgo';\nimport { Network } from '../networks';\nimport { mockReplayProtectionUnspent, mockWalletUnspent } from './mock';\n\n/**\n * input script type and value.\n */\nexport type TxnInputScriptType = Exclude<ScriptType, 'p2trMusig2'>;\nexport type TxnOutputScriptType = ScriptType2Of3;\n\n/**\n * output script type and value\n */\nexport interface TxnInput<TNumber extends number | bigint> {\n  scriptType: TxnInputScriptType;\n  value: TNumber;\n}\n\n/**\n * should set either address or scriptType, never both.\n * set isInternalAddress=true for internal output address\n */\nexport interface TxnOutput<TNumber extends number | bigint> {\n  address?: string;\n  scriptType?: TxnOutputScriptType;\n  value: TNumber;\n  isInternalAddress?: boolean;\n}\n\n/**\n * array of supported input script types.\n */\nexport const txnInputScriptTypes = ['p2sh', 'p2shP2wsh', 'p2wsh', 'p2tr', scriptTypeP2shP2pk] as const;\n\n/**\n * array of supported output script types.\n */\nexport const txnOutputScriptTypes = scriptTypes2Of3;\n\n/**\n * create unspent object from input script type, index, network and root wallet key.\n */\nexport function toTxnUnspent<TNumber extends number | bigint>(\n  input: TxnInput<TNumber>,\n  index: number,\n  network: Network,\n  rootWalletKeys: RootWalletKeys\n): Unspent<TNumber> {\n  if (input.scriptType === 'p2shP2pk') {\n    return mockReplayProtectionUnspent<TNumber>(network, input.value, { key: rootWalletKeys['user'], vout: index });\n  } else {\n    return mockWalletUnspent<TNumber>(network, input.value, {\n      chain: getInternalChainCode(input.scriptType),\n      vout: index,\n      keys: rootWalletKeys,\n      index,\n    });\n  }\n}\n\n/**\n * returns signer and cosigner names for TxnInputScriptType.\n * user and undefined as signer and cosigner respectively for p2shP2pk.\n * user and bitgo as signer and cosigner respectively for other input script types.\n */\nexport function getTxnSigners(inputType: TxnInputScriptType): { signerName: KeyName; cosignerName?: KeyName } {\n  return {\n    signerName: 'user',\n    cosignerName: inputType === 'p2shP2pk' ? undefined : 'bitgo',\n  };\n}\n\n/**\n * signs with first or second signature for single input.\n * p2shP2pk is signed only with first sign.\n */\nexport function signTxnInput<TNumber extends number | bigint>(\n  txb: UtxoTransactionBuilder<TNumber>,\n  input: TxnInput<TNumber>,\n  inputIndex: number,\n  rootWalletKeys: RootWalletKeys,\n  sign: 'halfsigned' | 'fullsigned',\n  signers?: { signerName: KeyName; cosignerName?: KeyName }\n): void {\n  const { signerName, cosignerName } = signers ? signers : getTxnSigners(input.scriptType);\n  const unspent = toTxnUnspent(input, inputIndex, txb.network, rootWalletKeys);\n  if (sign === 'halfsigned') {\n    if (input.scriptType === 'p2shP2pk') {\n      signInputP2shP2pk(txb, inputIndex, rootWalletKeys[signerName]);\n    } else if (isWalletUnspent(unspent) && cosignerName) {\n      signInputWithUnspent(\n        txb,\n        inputIndex,\n        unspent,\n        WalletUnspentSigner.from(rootWalletKeys, rootWalletKeys[signerName], rootWalletKeys[cosignerName])\n      );\n    }\n  }\n  if (isWalletUnspent(unspent) && sign === 'fullsigned' && cosignerName) {\n    signInputWithUnspent(\n      txb,\n      inputIndex,\n      unspent,\n      WalletUnspentSigner.from(rootWalletKeys, rootWalletKeys[cosignerName], rootWalletKeys[signerName])\n    );\n  }\n}\n\n/**\n * signs with first or second signature for all inputs.\n * p2shP2pk is signed only with first sign.\n */\nexport function signAllTxnInputs<TNumber extends number | bigint>(\n  txb: UtxoTransactionBuilder<TNumber>,\n  inputs: TxnInput<TNumber>[],\n  rootWalletKeys: RootWalletKeys,\n  sign: 'halfsigned' | 'fullsigned',\n  signers?: { signerName: KeyName; cosignerName?: KeyName }\n): void {\n  inputs.forEach((input, index) => {\n    signTxnInput(txb, input, index, rootWalletKeys, sign, signers);\n  });\n}\n\n/**\n * construct transaction for given inputs, outputs, network and root wallet keys.\n */\nexport function constructTxnBuilder<TNumber extends number | bigint>(\n  inputs: TxnInput<TNumber>[],\n  outputs: TxnOutput<TNumber>[],\n  network: Network,\n  rootWalletKeys: RootWalletKeys,\n  sign: 'unsigned' | 'halfsigned' | 'fullsigned',\n  signers?: { signerName: KeyName; cosignerName?: KeyName }\n): UtxoTransactionBuilder<TNumber> {\n  const totalInputAmount = inputs.reduce((sum, input) => sum + BigInt(input.value), BigInt(0));\n  const outputInputAmount = outputs.reduce((sum, output) => sum + BigInt(output.value), BigInt(0));\n  assert(totalInputAmount >= outputInputAmount, 'total output can not exceed total input');\n  assert(\n    !outputs.some((o) => (o.scriptType && o.address) || (!o.scriptType && !o.address)),\n    'only either output script type or address should be provided'\n  );\n\n  const txb = createTransactionBuilderForNetwork<TNumber>(network);\n\n  const unspents = inputs.map((input, i) => toTxnUnspent(input, i, network, rootWalletKeys));\n\n  unspents.forEach((u, i) => {\n    addToTransactionBuilder(txb, u);\n  });\n\n  outputs.forEach((output, i) => {\n    const address = output.scriptType\n      ? getWalletAddress(\n          rootWalletKeys,\n          output.isInternalAddress ? getInternalChainCode(output.scriptType) : getExternalChainCode(output.scriptType),\n          i,\n          network\n        )\n      : output.address;\n    if (!address) {\n      throw new Error('address is missing');\n    }\n    txb.addOutput(address, output.value);\n  });\n\n  if (sign === 'unsigned') {\n    return txb;\n  }\n\n  signAllTxnInputs(txb, inputs, rootWalletKeys, 'halfsigned', signers);\n\n  if (sign === 'fullsigned') {\n    signAllTxnInputs(txb, inputs, rootWalletKeys, sign, signers);\n  }\n\n  return txb;\n}\n"]}
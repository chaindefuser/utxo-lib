{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/WalletKeys.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/WalletKeys.ts"],"names":[],"mappings":";;;AAiBA,kCAEC;AAFD,SAAgB,WAAW,CAAC,CAAiB,EAAE,CAAiB;IAC9D,OAAO,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC;AACzC,CAAC;AAED;;;GAGG;AACH,MAAa,UAAU;IAGrB;;OAEG;IACH,YAA4B,MAA8B;QAA9B,WAAM,GAAN,MAAM,CAAwB;QACxD,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE;YACtB,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE;gBACtB,IAAI,WAAW,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;oBACjC,MAAM,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC;gBAClD,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,CAAmB,CAAC;IAC1E,CAAC;IAED,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IACxB,CAAC;IAED,IAAI,MAAM;QACR,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IACxB,CAAC;IAED,IAAI,KAAK;QACP,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IACxB,CAAC;CACF;AA7BD,gCA6BC;AAED;;;;GAIG;AACH,MAAa,iBAAkB,SAAQ,UAAU;IAC/C;;;OAGG;IACH,YAAmB,MAAsB,EAAS,KAAqB;QACrE,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAA2B,CAAC,CAAC;QADpE,WAAM,GAAN,MAAM,CAAgB;QAAS,UAAK,GAAL,KAAK,CAAgB;IAEvE,CAAC;CACF;AARD,8CAQC;AAED;;GAEG;AACH,MAAa,cAAe,SAAQ,UAAU;IAG5C;;;;OAIG;IACH,YACE,MAA8B,EACd,qBAAqC;QACnD,cAAc,CAAC,aAAa;QAC5B,cAAc,CAAC,aAAa;QAC5B,cAAc,CAAC,aAAa;KAC7B;QAED,KAAK,CAAC,MAAM,CAAC,CAAC;QANE,uBAAkB,GAAlB,kBAAkB,CAIjC;QAID,kBAAkB,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE;YAC/B,IAAI,CAAC,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;gBACzC,MAAM,IAAI,KAAK,CAAC,sDAAsD,CAAC,CAAC;YAC1E,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;;;;OAKG;IACH,iBAAiB,CAAC,GAAmB,EAAE,KAAa,EAAE,KAAa;QACjE,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC7B,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;QAC5C,CAAC;QACD,MAAM,MAAM,GAAG,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC,WAAW,CAAC,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC7F,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;YACzB,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;QAC3C,CAAC;QACD,OAAO,GAAG,MAAM,IAAI,KAAK,IAAI,KAAK,EAAE,CAAC;IACvC,CAAC;IAED;;;;OAIG;IACH,sBAAsB,CAAC,KAAa,EAAE,KAAa;QACjD,OAAO,IAAI,iBAAiB,CAC1B,IAAI,EACJ,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,CAAmB,CAClF,CAAC;IACJ,CAAC;;AApDH,wCAqDC;AApDiB,4BAAa,GAAG,KAAK,CAAC","sourcesContent":["/**\n * Classes for deriving key triples for wallet addresses.\n *\n * By default, BitGo wallets consist of a triple of bip32 extend keypairs.\n * Every wallet address can be identified by _(chain: number, index: number)_.\n * The key set for a particular address can be obtained by deriving with the path\n * `0/0/${chain}/${index}`. (In rare cases the prefix 0/0 can be different)\n *\n * Since we never use other derivations for utxo address scripts, the classes defined here only\n * allow exactly one level of derivation.\n */\nimport { BIP32Interface } from 'bip32';\n\nimport { Triple } from '../types';\n\nexport type KeyName = 'user' | 'backup' | 'bitgo';\n\nexport function eqPublicKey(a: BIP32Interface, b: BIP32Interface): boolean {\n  return a.publicKey.equals(b.publicKey);\n}\n\n/**\n * Base class for RootWalletKeys and DerivedWalletKeys.\n * Keys can be either public keys or private keys.\n */\nexport class WalletKeys {\n  public readonly publicKeys: Triple<Buffer>;\n\n  /**\n   * @param triple - bip32 key triple\n   */\n  constructor(public readonly triple: Triple<BIP32Interface>) {\n    triple.forEach((a, i) => {\n      triple.forEach((b, j) => {\n        if (eqPublicKey(a, b) && i !== j) {\n          throw new Error(`wallet keys must be distinct`);\n        }\n      });\n    });\n\n    this.publicKeys = this.triple.map((k) => k.publicKey) as Triple<Buffer>;\n  }\n\n  get user(): BIP32Interface {\n    return this.triple[0];\n  }\n\n  get backup(): BIP32Interface {\n    return this.triple[1];\n  }\n\n  get bitgo(): BIP32Interface {\n    return this.triple[2];\n  }\n}\n\n/**\n * Set of WalletKeys derived from RootWalletKeys. Suitable for signing transaction inputs.\n * Contains reference to the RootWalletKeys this was derived from as well as the paths used\n * for derivation.\n */\nexport class DerivedWalletKeys extends WalletKeys {\n  /**\n   * @param parent - wallet keys to derive from\n   * @param paths - paths to derive with\n   */\n  constructor(public parent: RootWalletKeys, public paths: Triple<string>) {\n    super(parent.triple.map((k, i) => k.derivePath(paths[i])) as Triple<BIP32Interface>);\n  }\n}\n\n/**\n * Set of root wallet keys, typically instantiated using the wallet xpub triple.\n */\nexport class RootWalletKeys extends WalletKeys {\n  static readonly defaultPrefix = '0/0';\n\n  /**\n   * @param triple - bip32 key triple\n   * @param derivationPrefixes - Certain v1 wallets or their migrated v2 counterparts\n   *                             can have a nonstandard prefix.\n   */\n  constructor(\n    triple: Triple<BIP32Interface>,\n    public readonly derivationPrefixes: Triple<string> = [\n      RootWalletKeys.defaultPrefix,\n      RootWalletKeys.defaultPrefix,\n      RootWalletKeys.defaultPrefix,\n    ]\n  ) {\n    super(triple);\n\n    derivationPrefixes.forEach((p) => {\n      if (p.startsWith('/') || p.endsWith('/')) {\n        throw new Error(`derivation prefix must not start or end with a slash`);\n      }\n    });\n  }\n\n  /**\n   * @param key\n   * @param chain\n   * @param index\n   * @return full derivation path for key, including key-specific prefix\n   */\n  getDerivationPath(key: BIP32Interface, chain: number, index: number): string {\n    if (!this.derivationPrefixes) {\n      throw new Error(`no derivation prefixes`);\n    }\n    const prefix = this.derivationPrefixes.find((prefix, i) => eqPublicKey(key, this.triple[i]));\n    if (prefix === undefined) {\n      throw new Error(`key not in walletKeys`);\n    }\n    return `${prefix}/${chain}/${index}`;\n  }\n\n  /**\n   * @param chain\n   * @param index\n   * @return walletKeys for a particular address identified by (chain, index)\n   */\n  deriveForChainAndIndex(chain: number, index: number): DerivedWalletKeys {\n    return new DerivedWalletKeys(\n      this,\n      this.triple.map((k) => this.getDerivationPath(k, chain, index)) as Triple<string>\n    );\n  }\n}\n"]}
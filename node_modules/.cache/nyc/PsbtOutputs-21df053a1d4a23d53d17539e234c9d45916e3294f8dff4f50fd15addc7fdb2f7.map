{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/psbt/PsbtOutputs.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/psbt/PsbtOutputs.ts"],"names":[],"mappings":";AAAA;;GAEG;;AAiBH,wDAMC;AASD,wCAaC;AAQD,0DAEC;AAQD,sEAIC;AAOD,8DAGC;AAOD,0EAGC;AArFD,uCAAoD;AACpD,uDAA8E;AAC9E,6CAA0C;AAE1C,gDAAsD;AAEtD,2CAAiD;AAEjD;;;;;;GAMG;AACH,SAAgB,sBAAsB,CAAC,KAAqB,EAAE,MAAkB;IAC9E,OAAO,MAAM,CAAC,kBAAkB,EAAE,MAAM;QACtC,CAAC,CAAC,mBAAQ,CAAC,aAAa,CAAC,KAAK,EAAE,MAAM,CAAC,kBAAkB,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;QAC7E,CAAC,CAAC,MAAM,CAAC,eAAe,EAAE,MAAM;YAChC,CAAC,CAAC,mBAAQ,CAAC,aAAa,CAAC,KAAK,EAAE,MAAM,CAAC,eAAe,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC;YAC3E,CAAC,CAAC,SAAS,CAAC;AAChB,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,cAAc,CAAC,IAAc,EAAE,WAAmB,EAAE,eAAuC;IACzG,MAAM,MAAM,GAAG,IAAA,sBAAc,EAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;IAE9D,MAAM,OAAO,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC,QAAQ,EAAE,EAAE,CAAC,sBAAsB,CAAC,QAAQ,EAAE,MAAM,CAAC,EAAE,SAAS,CAAC,CAAC;IAEvG,IAAI,CAAC,IAAA,qBAAa,EAAC,OAAO,CAAC,EAAE,CAAC;QAC5B,OAAO,KAAK,CAAC;IACf,CAAC;IAED,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,WAAW,CAAC,CAAC;IACvD,OAAO,+BAAe,CAAC,IAAI,CAAC,CAAC,UAAU,EAAE,EAAE,CACzC,IAAA,sCAAsB,EAAC,OAAO,EAAE,UAAU,CAAC,CAAC,YAAY,CAAC,MAAM,CAAC,YAAY,CAAC,CAC9E,CAAC;AACJ,CAAC;AAED;;;;;GAKG;AACH,SAAgB,uBAAuB,CAAC,IAAc,EAAE,eAAuC;IAC7F,OAAO,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,cAAc,CAAC,IAAI,EAAE,CAAC,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;AACpG,CAAC;AAED;;;;;GAKG;AACH,SAAgB,6BAA6B,CAAC,IAAc,EAAE,eAAuC;IACnG,MAAM,OAAO,GAAG,uBAAuB,CAAC,IAAI,EAAE,eAAe,CAAC,CAAC;IAC/D,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;IACjC,OAAO,OAAO,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;AACzE,CAAC;AAED;;;;GAIG;AACH,SAAgB,yBAAyB,CAAC,IAAc;IACtD,MAAM,SAAS,GAAG,IAAA,8BAAkB,EAAC,IAAI,CAAC,CAAC;IAC3C,OAAO,uBAAuB,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;AAClD,CAAC;AAED;;;;GAIG;AACH,SAAgB,+BAA+B,CAAC,IAAc;IAC5D,MAAM,SAAS,GAAG,IAAA,8BAAkB,EAAC,IAAI,CAAC,CAAC;IAC3C,OAAO,6BAA6B,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;AACxD,CAAC","sourcesContent":["/**\n * Contains helper methods for determining if a transaction output belongs to a given BitGo wallet\n */\n\nimport { isBufferArray, Triple } from '../../types';\nimport { createOutputScript2of3, scriptTypes2Of3 } from '../../outputScripts';\nimport { UtxoPsbt } from '../../UtxoPsbt';\nimport { BIP32Interface } from 'bip32';\nimport { checkForOutput } from 'bip174/src/lib/utils';\nimport { PsbtOutput } from 'bip174/src/lib/interfaces';\nimport { getSortedRootNodes } from './RootNodes';\n\n/**\n * Derives the appropriate BIP32 key pair for a given output.\n * It uses either tapBip32Derivation or bip32Derivation paths from the output.\n * @param bip32 - The BIP32Interface object to derive from.\n * @param output - The specific PSBT output to derive for.\n * @returns The derived BIP32 key pair if master fingerprint matches, or undefined.\n */\nexport function deriveKeyPairForOutput(bip32: BIP32Interface, output: PsbtOutput): BIP32Interface | undefined {\n  return output.tapBip32Derivation?.length\n    ? UtxoPsbt.deriveKeyPair(bip32, output.tapBip32Derivation, { ignoreY: true })\n    : output.bip32Derivation?.length\n    ? UtxoPsbt.deriveKeyPair(bip32, output.bip32Derivation, { ignoreY: false })\n    : undefined;\n}\n\n/**\n * Determines if a specified output in a PSBT is an output of the wallet represented by the given root nodes.\n * @param psbt - The PSBT to check.\n * @param outputIndex - The index of the output to check.\n * @param rootWalletNodes - The root nodes representing the wallet.\n * @returns A boolean indicating if the output belongs to the wallet.\n */\nexport function isWalletOutput(psbt: UtxoPsbt, outputIndex: number, rootWalletNodes: Triple<BIP32Interface>): boolean {\n  const output = checkForOutput(psbt.data.outputs, outputIndex);\n\n  const pubKeys = rootWalletNodes.map((rootNode) => deriveKeyPairForOutput(rootNode, output)?.publicKey);\n\n  if (!isBufferArray(pubKeys)) {\n    return false;\n  }\n\n  const outputScript = psbt.getOutputScript(outputIndex);\n  return scriptTypes2Of3.some((scriptType) =>\n    createOutputScript2of3(pubKeys, scriptType).scriptPubKey.equals(outputScript)\n  );\n}\n\n/**\n * Finds indices of all outputs in a PSBT that belong to the wallet represented by the given root nodes.\n * @param psbt - The PSBT to search through.\n * @param rootWalletNodes - The root nodes representing the wallet.\n * @returns An array of indices corresponding to wallet outputs.\n */\nexport function findWalletOutputIndices(psbt: UtxoPsbt, rootWalletNodes: Triple<BIP32Interface>): number[] {\n  return psbt.data.outputs.flatMap((_, i) => (isWalletOutput(psbt, i, rootWalletNodes) ? [i] : []));\n}\n\n/**\n * Calculates the total amount of all wallet outputs in a PSBT for the wallet represented by the given root nodes.\n * @param psbt - The PSBT to calculate for.\n * @param rootWalletNodes - The root nodes representing the wallet.\n * @returns The total amount of wallet outputs.\n */\nexport function getTotalAmountOfWalletOutputs(psbt: UtxoPsbt, rootWalletNodes: Triple<BIP32Interface>): bigint {\n  const indices = findWalletOutputIndices(psbt, rootWalletNodes);\n  const txOutputs = psbt.txOutputs;\n  return indices.reduce((sum, i) => sum + txOutputs[i].value, BigInt(0));\n}\n\n/**\n * Finds indices of all internal outputs in a PSBT, identified as outputs belonging to the wallet's root nodes within the PSBT.\n * @param psbt - The PSBT containing the wallet's root nodes as indicated by global Xpubs.\n * @returns An array of indices of internal outputs.\n */\nexport function findInternalOutputIndices(psbt: UtxoPsbt): number[] {\n  const rootNodes = getSortedRootNodes(psbt);\n  return findWalletOutputIndices(psbt, rootNodes);\n}\n\n/**\n * Calculates the total amount of all internal outputs in a PSBT, identified as outputs belonging to the wallet's root nodes within the PSBT.\n * @param psbt - The PSBT containing the wallet's root nodes as indicated by global Xpubs.\n * @returns The total amount of internal outputs.\n */\nexport function getTotalAmountOfInternalOutputs(psbt: UtxoPsbt): bigint {\n  const rootNodes = getSortedRootNodes(psbt);\n  return getTotalAmountOfWalletOutputs(psbt, rootNodes);\n}\n"]}
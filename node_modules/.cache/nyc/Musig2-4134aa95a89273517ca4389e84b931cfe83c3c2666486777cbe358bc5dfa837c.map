{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/Musig2.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/Musig2.ts"],"names":[],"mappings":"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","sourcesContent":["import { SessionKey } from '@brandonblack/musig';\n\nimport {\n  checkPlainPublicKey,\n  checkTapMerkleRoot,\n  checkTxHash,\n  checkXOnlyPublicKey,\n  toXOnlyPublicKey,\n} from './outputScripts';\nimport { ecc, musig } from '../noble_ecc';\nimport { Tuple } from './types';\nimport { calculateTapTweak, tapTweakPubkey } from '../taproot';\nimport { Transaction } from '../index';\nimport { PsbtInput } from 'bip174/src/lib/interfaces';\nimport {\n  getPsbtInputProprietaryKeyVals,\n  ProprietaryKeySubtype,\n  ProprietaryKeyValue,\n  PSBT_PROPRIETARY_IDENTIFIER,\n} from './PsbtUtil';\n\n/**\n *  Participant key value object.\n */\nexport interface PsbtMusig2Participants {\n  tapOutputKey: Buffer;\n  tapInternalKey: Buffer;\n  participantPubKeys: Tuple<Buffer>;\n}\n\nexport interface PsbtMusig2DeterministicParams {\n  privateKey: Buffer;\n  otherNonce: Buffer;\n  publicKeys: Tuple<Buffer>;\n  internalPubKey: Buffer;\n  tapTreeRoot: Buffer;\n  hash: Buffer;\n}\n\n/**\n *  Nonce key value object.\n */\nexport interface PsbtMusig2PubNonce {\n  participantPubKey: Buffer;\n  tapOutputKey: Buffer;\n  pubNonce: Buffer;\n}\n\n/**\n *  Partial signature key value object.\n */\nexport interface PsbtMusig2PartialSig {\n  participantPubKey: Buffer;\n  tapOutputKey: Buffer;\n  partialSig: Buffer;\n}\n\n/**\n * Because musig uses reference-equal buffers to cache nonces, we wrap it here to allow using\n * nonces that are byte-equal but not reference-equal.\n */\nexport class Musig2NonceStore {\n  private nonces: Uint8Array[] = [];\n\n  /**\n   * Get original Buffer instance for nonce (which may be a copy).\n   * @return byte-equal buffer that is reference-equal to what was stored earlier in createMusig2Nonce\n   */\n  getRef(nonce: Uint8Array): Uint8Array {\n    for (const b of this.nonces) {\n      if (Buffer.from(b).equals(nonce)) {\n        return b;\n      }\n    }\n    throw new Error(`unknown nonce`);\n  }\n\n  /**\n   * Creates musig2 nonce and stores buffer reference.\n   * tapInternalkey, tapMerkleRoot, tapBip32Derivation for rootWalletKey are required per p2trMusig2 key path input.\n   * Also participant keys are required from psbt proprietary key values.\n   * Ref: https://gist.github.com/sanket1729/4b525c6049f4d9e034d27368c49f28a6\n   * @param privateKey - signer private key\n   * @param publicKey - signer xy public key\n   * @param xOnlyPublicKey - tweaked aggregated key (tapOutputKey)\n   * @param sessionId Additional entropy. If provided it must either be a counter unique to this secret key,\n   * (converted to an array of 32 bytes), or 32 uniformly random bytes.\n   */\n  createMusig2Nonce(\n    privateKey: Uint8Array,\n    publicKey: Uint8Array,\n    xOnlyPublicKey: Uint8Array,\n    txHash: Uint8Array,\n    sessionId?: Buffer\n  ): Uint8Array {\n    if (txHash.length != 32) {\n      throw new Error(`Invalid txHash size ${txHash}`);\n    }\n    const buf = musig.nonceGen({ secretKey: privateKey, publicKey, xOnlyPublicKey, msg: txHash, sessionId });\n    this.nonces.push(buf);\n    return buf;\n  }\n}\n\n/**\n * Psbt proprietary key val util function for participants pub keys. SubType is 0x01\n * Ref: https://gist.github.com/sanket1729/4b525c6049f4d9e034d27368c49f28a6\n * @return x-only tapOutputKey||tapInternalKey as sub keydata, plain sigining participant keys as valuedata\n */\nexport function encodePsbtMusig2Participants(participants: PsbtMusig2Participants): ProprietaryKeyValue {\n  const keydata = [participants.tapOutputKey, participants.tapInternalKey].map((pubkey) => checkXOnlyPublicKey(pubkey));\n  const value = participants.participantPubKeys.map((pubkey) => checkPlainPublicKey(pubkey));\n  const key = {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PARTICIPANT_PUB_KEYS,\n    keydata: Buffer.concat(keydata),\n  };\n  return { key, value: Buffer.concat(value) };\n}\n\n/**\n * Psbt proprietary key val util function for pub nonce. SubType is 0x02\n * Ref: https://gist.github.com/sanket1729/4b525c6049f4d9e034d27368c49f28a6\n * @return plain-participantPubKey||x-only-tapOutputKey as sub keydata, 66 bytes of 2 pub nonces as valuedata\n */\nexport function encodePsbtMusig2PubNonce(nonce: PsbtMusig2PubNonce): ProprietaryKeyValue {\n  if (nonce.pubNonce.length !== 66) {\n    throw new Error(`Invalid pubNonces length ${nonce.pubNonce.length}`);\n  }\n  const keydata = Buffer.concat([\n    checkPlainPublicKey(nonce.participantPubKey),\n    checkXOnlyPublicKey(nonce.tapOutputKey),\n  ]);\n  const key = {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PUB_NONCE,\n    keydata,\n  };\n  return { key, value: nonce.pubNonce };\n}\n\nexport function encodePsbtMusig2PartialSig(partialSig: PsbtMusig2PartialSig): ProprietaryKeyValue {\n  if (partialSig.partialSig.length !== 32 && partialSig.partialSig.length !== 33) {\n    throw new Error(`Invalid partialSig length ${partialSig.partialSig.length}`);\n  }\n  const keydata = Buffer.concat([\n    checkPlainPublicKey(partialSig.participantPubKey),\n    checkXOnlyPublicKey(partialSig.tapOutputKey),\n  ]);\n  const key = {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PARTIAL_SIG,\n    keydata,\n  };\n  return { key, value: partialSig.partialSig };\n}\n\n/**\n * Decodes proprietary key value data for participant pub keys\n * @param kv\n */\nexport function decodePsbtMusig2Participants(kv: ProprietaryKeyValue): PsbtMusig2Participants {\n  if (\n    kv.key.identifier !== PSBT_PROPRIETARY_IDENTIFIER ||\n    kv.key.subtype !== ProprietaryKeySubtype.MUSIG2_PARTICIPANT_PUB_KEYS\n  ) {\n    throw new Error(`Invalid identifier ${kv.key.identifier} or subtype ${kv.key.subtype} for participants pub keys`);\n  }\n\n  const key = kv.key.keydata;\n  if (key.length !== 64) {\n    throw new Error(`Invalid keydata size ${key.length} for participant pub keys`);\n  }\n\n  const value = kv.value;\n  if (value.length !== 66) {\n    throw new Error(`Invalid valuedata size ${value.length} for participant pub keys`);\n  }\n  const participantPubKeys: Tuple<Buffer> = [value.subarray(0, 33), value.subarray(33)];\n  if (participantPubKeys[0].equals(participantPubKeys[1])) {\n    throw new Error(`Duplicate participant pub keys found`);\n  }\n\n  return { tapOutputKey: key.subarray(0, 32), tapInternalKey: key.subarray(32), participantPubKeys };\n}\n\n/**\n * Decodes proprietary key value data for musig2 nonce\n * @param kv\n */\nexport function decodePsbtMusig2Nonce(kv: ProprietaryKeyValue): PsbtMusig2PubNonce {\n  if (kv.key.identifier !== PSBT_PROPRIETARY_IDENTIFIER || kv.key.subtype !== ProprietaryKeySubtype.MUSIG2_PUB_NONCE) {\n    throw new Error(`Invalid identifier ${kv.key.identifier} or subtype ${kv.key.subtype} for nonce`);\n  }\n\n  const key = kv.key.keydata;\n  if (key.length !== 65) {\n    throw new Error(`Invalid keydata size ${key.length} for nonce`);\n  }\n\n  const value = kv.value;\n  if (value.length !== 66) {\n    throw new Error(`Invalid valuedata size ${value.length} for nonce`);\n  }\n\n  return { participantPubKey: key.subarray(0, 33), tapOutputKey: key.subarray(33), pubNonce: value };\n}\n\n/**\n * Decodes proprietary key value data for musig2 partial sig\n * @param kv\n */\nexport function decodePsbtMusig2PartialSig(kv: ProprietaryKeyValue): PsbtMusig2PartialSig {\n  if (\n    kv.key.identifier !== PSBT_PROPRIETARY_IDENTIFIER ||\n    kv.key.subtype !== ProprietaryKeySubtype.MUSIG2_PARTIAL_SIG\n  ) {\n    throw new Error(`Invalid identifier ${kv.key.identifier} or subtype ${kv.key.subtype} for partial sig`);\n  }\n\n  const key = kv.key.keydata;\n  if (key.length !== 65) {\n    throw new Error(`Invalid keydata size ${key.length} for partial sig`);\n  }\n\n  const value = kv.value;\n  if (value.length !== 32 && value.length !== 33) {\n    throw new Error(`Invalid valuedata size ${value.length} for partial sig`);\n  }\n\n  return { participantPubKey: key.subarray(0, 33), tapOutputKey: key.subarray(33), partialSig: value };\n}\n\nexport function createTapInternalKey(plainPubKeys: Buffer[]): Buffer {\n  return Buffer.from(musig.getXOnlyPubkey(musig.keyAgg(plainPubKeys)));\n}\n\nexport function createTapOutputKey(internalPubKey: Buffer, tapTreeRoot: Buffer): Buffer {\n  return Buffer.from(\n    tapTweakPubkey(ecc, toXOnlyPublicKey(internalPubKey), checkTapMerkleRoot(tapTreeRoot)).xOnlyPubkey\n  );\n}\n\nexport function createAggregateNonce(pubNonces: Tuple<Buffer>): Buffer {\n  return Buffer.from(musig.nonceAgg(pubNonces));\n}\n\nexport function createTapTweak(tapInternalKey: Buffer, tapMerkleRoot: Buffer): Buffer {\n  return Buffer.from(calculateTapTweak(checkXOnlyPublicKey(tapInternalKey), checkTapMerkleRoot(tapMerkleRoot)));\n}\n\nfunction startMusig2SigningSession(\n  aggNonce: Buffer,\n  hash: Buffer,\n  publicKeys: Tuple<Buffer>,\n  tweak: Buffer\n): SessionKey {\n  return musig.startSigningSession(aggNonce, hash, publicKeys, { tweak, xOnly: true });\n}\n\nexport function musig2PartialSign(\n  privateKey: Buffer,\n  publicNonce: Uint8Array,\n  sessionKey: SessionKey,\n  nonceStore: Musig2NonceStore\n): Buffer {\n  checkTxHash(Buffer.from(sessionKey.msg));\n  return Buffer.from(\n    musig.partialSign({\n      secretKey: privateKey,\n      publicNonce: nonceStore.getRef(publicNonce),\n      sessionKey,\n    })\n  );\n}\n\nexport function musig2PartialSigVerify(\n  sig: Buffer,\n  publicKey: Buffer,\n  publicNonce: Buffer,\n  sessionKey: SessionKey\n): boolean {\n  checkTxHash(Buffer.from(sessionKey.msg));\n  return musig.partialVerify({ sig, publicKey, publicNonce, sessionKey });\n}\n\nexport function musig2AggregateSigs(sigs: Buffer[], sessionKey: SessionKey): Buffer {\n  return Buffer.from(musig.signAgg(sigs, sessionKey));\n}\n\n/** @return session key that can be used to reference the session later */\nexport function createMusig2SigningSession(sessionArgs: {\n  pubNonces: Tuple<Buffer>;\n  txHash: Buffer;\n  pubKeys: Tuple<Buffer>;\n  internalPubKey: Buffer;\n  tapTreeRoot: Buffer;\n}): SessionKey {\n  checkTxHash(sessionArgs.txHash);\n  const aggNonce = createAggregateNonce(sessionArgs.pubNonces);\n  const tweak = createTapTweak(sessionArgs.internalPubKey, sessionArgs.tapTreeRoot);\n  return startMusig2SigningSession(aggNonce, sessionArgs.txHash, sessionArgs.pubKeys, tweak);\n}\n\n/**\n * @returns psbt proprietary key for musig2 participant key value data\n * If no key value exists, undefined is returned.\n */\nexport function parsePsbtMusig2Participants(input: PsbtInput): PsbtMusig2Participants | undefined {\n  const participantsKeyVals = getPsbtInputProprietaryKeyVals(input, {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PARTICIPANT_PUB_KEYS,\n  });\n\n  if (!participantsKeyVals.length) {\n    return undefined;\n  }\n\n  if (participantsKeyVals.length > 1) {\n    throw new Error(`Found ${participantsKeyVals.length} matching participant key value instead of 1`);\n  }\n\n  return decodePsbtMusig2Participants(participantsKeyVals[0]);\n}\n\n/**\n * @returns psbt proprietary key for musig2 public nonce key value data\n * If no key value exists, undefined is returned.\n */\nexport function parsePsbtMusig2Nonces(input: PsbtInput): PsbtMusig2PubNonce[] | undefined {\n  const nonceKeyVals = getPsbtInputProprietaryKeyVals(input, {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PUB_NONCE,\n  });\n\n  if (!nonceKeyVals.length) {\n    return undefined;\n  }\n\n  if (nonceKeyVals.length > 2) {\n    throw new Error(`Found ${nonceKeyVals.length} matching nonce key value instead of 1 or 2`);\n  }\n\n  return nonceKeyVals.map((kv) => decodePsbtMusig2Nonce(kv));\n}\n\n/**\n * @returns psbt proprietary key for musig2 partial sig key value data\n * If no key value exists, undefined is returned.\n */\nexport function parsePsbtMusig2PartialSigs(input: PsbtInput): PsbtMusig2PartialSig[] | undefined {\n  const sigKeyVals = getPsbtInputProprietaryKeyVals(input, {\n    identifier: PSBT_PROPRIETARY_IDENTIFIER,\n    subtype: ProprietaryKeySubtype.MUSIG2_PARTIAL_SIG,\n  });\n\n  if (!sigKeyVals.length) {\n    return undefined;\n  }\n\n  if (sigKeyVals.length > 2) {\n    throw new Error(`Found ${sigKeyVals.length} matching partial signature key value instead of 1 or 2`);\n  }\n\n  return sigKeyVals.map((kv) => decodePsbtMusig2PartialSig(kv));\n}\n\n/**\n * Assert musig2 participant key value data with tapInternalKey and tapMerkleRoot.\n * <tapOutputKey><tapInputKey> => <participantKey1><participantKey2>\n * Using tapMerkleRoot and 2 participant keys, the tapInputKey is validated and using tapMerkleRoot and tapInputKey,\n * the tapOutputKey is validated.\n */\nexport function assertPsbtMusig2Participants(\n  participantKeyValData: PsbtMusig2Participants,\n  tapInternalKey: Buffer,\n  tapMerkleRoot: Buffer\n): void {\n  checkXOnlyPublicKey(tapInternalKey);\n  checkTapMerkleRoot(tapMerkleRoot);\n\n  const participantPubKeys = participantKeyValData.participantPubKeys;\n\n  const internalKey = createTapInternalKey(participantPubKeys);\n  if (!internalKey.equals(participantKeyValData.tapInternalKey)) {\n    throw new Error('Invalid participants keydata tapInternalKey');\n  }\n\n  const outputKey = createTapOutputKey(internalKey, tapMerkleRoot);\n  if (!outputKey.equals(participantKeyValData.tapOutputKey)) {\n    throw new Error('Invalid participants keydata tapOutputKey');\n  }\n\n  if (!internalKey.equals(tapInternalKey)) {\n    throw new Error('tapInternalKey and aggregated participant pub keys does not match');\n  }\n}\n\n/**\n * Assert musig2 public nonce key value data with participant key value data\n * (refer assertPsbtMusig2ParticipantsKeyValData).\n * <participantKey1><tapOutputKey> => <pubNonce1>\n * <participantKey2><tapOutputKey> => <pubNonce2>\n * Checks against participant keys and tapOutputKey\n */\nexport function assertPsbtMusig2Nonces(\n  noncesKeyValData: PsbtMusig2PubNonce[],\n  participantKeyValData: PsbtMusig2Participants\n): void {\n  checkXOnlyPublicKey(participantKeyValData.tapOutputKey);\n  participantKeyValData.participantPubKeys.forEach((kv) => checkPlainPublicKey(kv));\n  if (participantKeyValData.participantPubKeys[0].equals(participantKeyValData.participantPubKeys[1])) {\n    throw new Error(`Duplicate participant pub keys found`);\n  }\n\n  if (noncesKeyValData.length > 2) {\n    throw new Error(`Invalid nonce key value count ${noncesKeyValData.length}`);\n  }\n\n  noncesKeyValData.forEach((nonceKv) => {\n    const index = participantKeyValData.participantPubKeys.findIndex((pubKey) =>\n      nonceKv.participantPubKey.equals(pubKey)\n    );\n    if (index < 0) {\n      throw new Error('Invalid nonce keydata participant pub key');\n    }\n\n    if (!nonceKv.tapOutputKey.equals(participantKeyValData.tapOutputKey)) {\n      throw new Error('Invalid nonce keydata tapOutputKey');\n    }\n  });\n}\n\n/**\n * @returns Input object but sig hash type data is taken out from partialSig field.\n * If sig hash type is not common for all sigs, error out, otherwise returns the modified object and single hash type.\n */\nexport function getSigHashTypeFromSigs(partialSigs: PsbtMusig2PartialSig[]): {\n  partialSigs: PsbtMusig2PartialSig[];\n  sigHashType: number;\n} {\n  if (!partialSigs.length) {\n    throw new Error('partialSigs array can not be empty');\n  }\n  const pSigsWithHashType = partialSigs.map((kv) => {\n    const { partialSig, participantPubKey, tapOutputKey } = kv;\n    return partialSig.length === 33\n      ? { pSig: { partialSig: partialSig.slice(0, 32), participantPubKey, tapOutputKey }, sigHashType: partialSig[32] }\n      : { pSig: { partialSig, participantPubKey, tapOutputKey }, sigHashType: Transaction.SIGHASH_DEFAULT };\n  });\n\n  const sigHashType = pSigsWithHashType[0].sigHashType;\n  if (!pSigsWithHashType.every((pSig) => pSig.sigHashType === sigHashType)) {\n    throw new Error('signatures must use same sig hash type');\n  }\n\n  return { partialSigs: pSigsWithHashType.map(({ pSig }) => pSig), sigHashType };\n}\n\nexport function createMusig2DeterministicNonce(params: PsbtMusig2DeterministicParams): Buffer {\n  return Buffer.from(\n    musig.deterministicNonceGen({\n      secretKey: params.privateKey,\n      aggOtherNonce: musig.nonceAgg([params.otherNonce]),\n      publicKeys: params.publicKeys,\n      tweaks: [{ tweak: createTapTweak(params.internalPubKey, params.tapTreeRoot), xOnly: true }],\n      msg: params.hash,\n    }).publicNonce\n  );\n}\n\nexport function musig2DeterministicSign(params: PsbtMusig2DeterministicParams): {\n  sig: Buffer;\n  sessionKey: SessionKey;\n  publicNonce: Buffer;\n} {\n  const { sig, sessionKey, publicNonce } = musig.deterministicSign({\n    secretKey: params.privateKey,\n    aggOtherNonce: musig.nonceAgg([params.otherNonce]),\n    publicKeys: params.publicKeys,\n    tweaks: [{ tweak: createTapTweak(params.internalPubKey, params.tapTreeRoot), xOnly: true }],\n    msg: params.hash,\n  });\n  return { sig: Buffer.from(sig), sessionKey, publicNonce: Buffer.from(publicNonce) };\n}\n"]}
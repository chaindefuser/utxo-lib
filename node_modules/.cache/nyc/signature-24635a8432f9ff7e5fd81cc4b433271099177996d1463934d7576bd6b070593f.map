{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/signature.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/signature.ts"],"names":[],"mappings":";;AA2DA,8DAkKC;AAUD,0CAwBC;AAuBD,kEAsBC;AASD,sEAOC;AAUD,oEAOC;AAED,8CAgBC;AAED,8CAkBC;AAED,sCAgCC;AAnZD,iDAAgF;AAEhF,uDAAoD;AAEpD,mDAQyB;AAEzB,0CAA4D;AAC5D,4CAA6C;AAC7C,6CAAwD;AACxD,wCAAiD;AA8BjD;;;;;;;;;GASG;AACH,SAAgB,yBAAyB,CACvC,WAAqC,EACrC,UAAkB,EAClB,MAAe,EACf,uBAA6C,EAAE,EAC/C,WAAiC;IAEjC,0BAA0B;IAC1B,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC;QACrB,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;IACzC,CAAC;IAED,MAAM,KAAK,GAAG,WAAW,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;IAC1C,0BAA0B;IAC1B,IAAI,CAAC,KAAK,EAAE,CAAC;QACX,MAAM,IAAI,KAAK,CAAC,qBAAqB,UAAU,EAAE,CAAC,CAAC;IACrD,CAAC;IAED,IAAI,CAAC,CAAC,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,MAAM,KAAK,CAAC,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QAC/E,iCAAiC;QACjC,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,MAAM,YAAY,GAAG,IAAA,qCAAwB,EAAC,KAAK,CAAC,CAAC;IAErD,IAAI,YAAY,CAAC,UAAU,KAAK,qBAAqB,IAAI,YAAY,CAAC,UAAU,KAAK,wBAAwB,EAAE,CAAC;QAC9G,IACE,YAAY,CAAC,UAAU,KAAK,qBAAqB;YACjD,CAAC,oBAAoB,CAAC,cAAc,IAAI,oBAAoB,CAAC,SAAS,CAAC,EACvE,CAAC;YACD,MAAM,IAAI,KAAK,CAAC,+EAA+E,CAAC,CAAC;QACnG,CAAC;QAED,IAAI,oBAAoB,CAAC,cAAc,KAAK,SAAS,EAAE,CAAC;YACtD,MAAM,IAAI,KAAK,CAAC,mEAAmE,CAAC,CAAC;QACvF,CAAC;QAED,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;QACzC,CAAC;QAED,IAAI,WAAW,CAAC,MAAM,KAAK,WAAW,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;YAClD,MAAM,IAAI,KAAK,CAAC,sBAAsB,WAAW,CAAC,MAAM,cAAc,WAAW,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QAClG,CAAC;IACH,CAAC;IAED,IACE,YAAY,CAAC,UAAU,KAAK,qBAAqB;QACjD,YAAY,CAAC,UAAU,KAAK,wBAAwB;QACpD,WAAW,EACX,CAAC;QACD,MAAM,aAAa,GAAG,WAAW,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC;QAErD,MAAM,MAAM,GAAG,IAAA,+BAAe,EAAC,YAAY,CAAC,UAAU,EAAE,YAAY,CAAC,SAAS,CAAC,CAAC;QAChF,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC;YAClC,MAAM,IAAI,KAAK,CACb,kBAAkB,aAAa,CAAC,QAAQ,CAAC,KAAK,CAAC,mCAAmC,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,CAC3G,CAAC;QACJ,CAAC;IACH,CAAC;IAED,IAAI,UAAoB,CAAC;IACzB,IAAI,YAAY,CAAC,UAAU,KAAK,qBAAqB,EAAE,CAAC;QACtD,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;QACzC,CAAC;QACD,UAAU,GAAG,CAAC,IAAA,6BAAmB,EAAC,WAAW,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;IACrE,CAAC;SAAM,CAAC;QACN,UAAU,GAAG,YAAY,CAAC,UAAU,CAAC,MAAM,CACzC,CAAC,GAAG,EAAE,EAAE,CACN,oBAAoB,CAAC,SAAS,KAAK,SAAS;YAC5C,oBAAoB,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC;YAC1C,oBAAoB,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CACtD,CAAC;IACJ,CAAC;IAED,MAAM,UAAU,GAAG,YAAY,CAAC,UAAU;SACvC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC;SAC5B,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,oBAAoB,CAAC,cAAc,KAAK,SAAS,IAAI,oBAAoB,CAAC,cAAc,KAAK,CAAC,CAAC,CAAC;IAEpH,OAAO,UAAU,CAAC,GAAG,CAAC,CAAC,eAAe,EAAyB,EAAE;QAC/D,IAAI,eAAe,KAAK,CAAC,IAAI,eAAe,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC1D,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;QACvD,CAAC;QAED,IAAI,QAAQ,GAAG,2BAAW,CAAC,eAAe,CAAC;QAE3C,IAAI,eAAe,CAAC,MAAM,KAAK,EAAE,EAAE,CAAC;YAClC,QAAQ,GAAG,eAAe,CAAC,eAAe,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YACvD,eAAe,GAAG,eAAe,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;QACjD,CAAC;QAED,IAAI,YAAY,CAAC,UAAU,KAAK,wBAAwB,EAAE,CAAC;YACzD,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;YACzC,CAAC;YACD,MAAM,EAAE,YAAY,EAAE,SAAS,EAAE,GAAG,YAAY,CAAC;YACjD,MAAM,QAAQ,GAAG,uBAAO,CAAC,cAAc,CAAC,eAAM,EAAE,YAAY,EAAE,SAAS,CAAC,CAAC;YACzE,MAAM,aAAa,GAAG,WAAW,CAAC,gBAAgB,CAChD,UAAU,EACV,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,CAAC,MAAM,CAAC,EACvC,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,KAAK,CAAC,EACrC,QAAQ,EACR,QAAQ,CACT,CAAC;YAEF,MAAM,QAAQ,GAAG,UAAU,CAAC,MAAM,CAChC,CAAC,CAAC,EAAE,EAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,eAAM,CAAC,aAAa,CAAC,aAAa,EAAE,CAAC,EAAE,eAAe,CAAC,CACnG,CAAC;YAEF,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC1B,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;YACvD,CAAC;YACD,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC1B,OAAO,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC,EAAE,SAAS,EAAE,eAAe,EAAE,CAAC;YAC/D,CAAC;YACD,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC,CAAC;QACnE,CAAC;aAAM,IAAI,YAAY,CAAC,UAAU,KAAK,qBAAqB,EAAE,CAAC;YAC7D,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;YACzC,CAAC;YACD,MAAM,aAAa,GAAG,WAAW,CAAC,gBAAgB,CAChD,UAAU,EACV,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,EAAE,CAAC,MAAM,CAAC,EACvC,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,KAAK,CAAC,EACrC,QAAQ,CACT,CAAC;YACF,MAAM,MAAM,GAAG,eAAM,CAAC,aAAa,CAAC,aAAa,EAAE,UAAU,CAAC,CAAC,CAAC,EAAE,eAAe,CAAC,CAAC;YACnF,OAAO,MAAM;gBACX,CAAC,CAAC,EAAE,QAAQ,EAAE,UAAU,CAAC,CAAC,CAAC,EAAE,SAAS,EAAE,eAAe,EAAE;gBACzD,CAAC,CAAC,EAAE,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;QACpD,CAAC;aAAM,CAAC;YACN,+EAA+E;YAC/E,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,+BAAe,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;YACxE,MAAM,eAAe,GACnB,YAAY,CAAC,UAAU,KAAK,WAAW,IAAI,YAAY,CAAC,UAAU,KAAK,OAAO;gBAC5E,CAAC,CAAC,WAAW,CAAC,gBAAgB,CAAC,UAAU,EAAE,YAAY,CAAC,SAAS,EAAE,MAAM,EAAE,QAAQ,CAAC;gBACpF,CAAC,CAAC,WAAW,CAAC,yBAAyB,CAAC,UAAU,EAAE,YAAY,CAAC,SAAS,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC;YAClG,MAAM,QAAQ,GAAG,UAAU,CAAC,MAAM,CAAC,CAAC,SAAS,EAAE,EAAE,CAC/C,eAAM,CAAC,MAAM,CACX,eAAe,EACf,SAAS,EACT,SAAS;YACT;;;;;cAKE;YACF,IAAI,CACL,CACF,CAAC;YAEF,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC1B,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;YACvD,CAAC;YACD,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC1B,OAAO,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC,EAAE,SAAS,EAAE,eAAe,EAAE,CAAC;YAC/D,CAAC;YACD,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC,CAAC;QACnE,CAAC;IACH,CAAC,CAAC,CAAC;AACL,CAAC;AAED;;;;;;;GAOG;AACH,SAAgB,eAAe,CAC7B,WAAqC,EACrC,UAAkB,EAClB,MAAe,EACf,uBAA6C,EAAE,EAC/C,WAAiC;IAEjC,MAAM,sBAAsB,GAAG,yBAAyB,CACtD,WAAW,EACX,UAAU,EACV,MAAM,EACN,oBAAoB,EACpB,WAAW,CACZ,CAAC,MAAM,CACN,CAAC,CAAC,EAAE,EAAE;IACJ,gFAAgF;IAChF,6EAA6E;IAC7E,oBAAoB,CAAC,SAAS,KAAK,SAAS;QAC5C,CAAC,CAAC,CAAC,QAAQ,KAAK,SAAS;YACvB,CAAC,oBAAoB,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC;gBAChD,oBAAoB,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CACnE,CAAC;IAEF,OAAO,sBAAsB,CAAC,MAAM,GAAG,CAAC,IAAI,sBAAsB,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,QAAQ,KAAK,SAAS,CAAC,CAAC;AAC5G,CAAC;AAED;;;;GAIG;AACH,SAAS,sBAAsB,CAAC,CAAwB,EAAE,SAAiB;IACzE,OAAO,CACL,CAAC,CAAC,CAAC,CAAC,QAAQ;QACZ,CAAC,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,SAAS,CAAC;YAC3B,+GAA+G;YAC/G,CAAC,SAAS,CAAC,MAAM,KAAK,EAAE,IAAI,sBAAsB,CAAC,CAAC,EAAE,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAC9E,CAAC;AACJ,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,2BAA2B,CACzC,WAAqC,EACrC,UAAkB,EAClB,WAAgC,EAChC,UAAoB;IAEpB,IAAI,WAAW,CAAC,GAAG,CAAC,MAAM,KAAK,WAAW,CAAC,MAAM,EAAE,CAAC;QAClD,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC,CAAC;IAChE,CAAC;IAED,MAAM,sBAAsB,GAAG,yBAAyB,CACtD,WAAW,EACX,UAAU,EACV,WAAW,CAAC,UAAU,CAAC,CAAC,KAAK,EAC7B,EAAE,EACF,WAAW,CACZ,CAAC;IAEF,OAAO,UAAU,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,EAAE;QAClC,MAAM,CAAC,GAAG,sBAAsB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,sBAAsB,CAAC,CAAC,EAAE,SAAS,CAAC,CAAC,CAAC;QACnF,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;IACrC,CAAC,CAAC,CAAC;AACL,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,6BAA6B,CAC3C,WAAqC,EACrC,UAAkB,EAClB,WAAgC,EAChC,UAAoB;IAEpB,OAAO,2BAA2B,CAAC,WAAW,EAAE,UAAU,EAAE,WAAW,EAAE,UAAU,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,SAAS,CAAC,CAAC;AACnH,CAAC;AAED;;;;;;;GAOG;AACH,SAAgB,4BAA4B,CAC1C,WAAqC,EACrC,UAAkB,EAClB,WAAgC,EAChC,SAAiB;IAEjB,OAAO,6BAA6B,CAAC,WAAW,EAAE,UAAU,EAAE,WAAW,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAC7F,CAAC;AAED,SAAgB,iBAAiB,CAAC,OAAgB,EAAE,UAAuB;IACzE,QAAQ,IAAA,qBAAU,EAAC,OAAO,CAAC,EAAE,CAAC;QAC5B,KAAK,mBAAQ,CAAC,WAAW,CAAC;QAC1B,KAAK,mBAAQ,CAAC,SAAS,CAAC;QACxB,KAAK,mBAAQ,CAAC,WAAW,CAAC;QAC1B,KAAK,mBAAQ,CAAC,KAAK;YACjB,OAAO,2BAAW,CAAC,WAAW,GAAG,iCAAe,CAAC,cAAc,CAAC;QAClE;YACE,QAAQ,UAAU,EAAE,CAAC;gBACnB,KAAK,MAAM,CAAC;gBACZ,KAAK,YAAY;oBACf,OAAO,2BAAW,CAAC,eAAe,CAAC;gBACrC;oBACE,OAAO,2BAAW,CAAC,WAAW,CAAC;YACnC,CAAC;IACL,CAAC;AACH,CAAC;AAED,SAAgB,iBAAiB,CAC/B,SAA0C,EAC1C,GAAW,EACX,OAAuB;IAEvB,MAAM,iBAAiB,GAAG,WAAW,CAAC;IACtC,MAAM,EAAE,YAAY,EAAE,aAAa,EAAE,GAAG,IAAA,0CAA0B,EAAC,OAAO,CAAC,SAAS,CAAC,CAAC;IACtF,OAAO,CAAC,OAAO,GAAG,SAAS,CAAC,OAAO,CAAC;IAEpC,SAAS,CAAC,IAAI,CAAC;QACb,GAAG;QACH,iBAAiB;QACjB,OAAO;QACP,QAAQ,EAAE,iBAAiB,CAAC,SAAS,CAAC,OAAkB,CAAC;QACzD,YAAY;QACZ,aAAa;QACb,YAAY,EAAE,SAAS;KACxB,CAAC,CAAC;AACL,CAAC;AAED,SAAgB,aAAa,CAC3B,SAA0C,EAC1C,GAAW,EACX,UAA0B,EAC1B,OAAuB,EACvB,OAAuB,EACvB,QAAgB,EAChB,MAAe;IAEf,IAAI,YAAY,CAAC;IACjB,IAAI,YAAY,CAAC;IACjB,IAAI,aAAa,CAAC;IAElB,MAAM,iBAAiB,GAAG,IAAA,2CAA2B,EAAC,UAAU,CAAC,CAAC;IAClE,IAAI,UAAU,KAAK,MAAM,EAAE,CAAC;QAC1B,CAAC,EAAE,aAAa,EAAE,YAAY,EAAE,GAAG,IAAA,qCAAqB,EAAC,OAAO,EAAE,CAAC,OAAO,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC,CAAC,CAAC;IACpG,CAAC;SAAM,CAAC;QACN,CAAC,EAAE,YAAY,EAAE,aAAa,EAAE,GAAG,IAAA,sCAAsB,EAAC,OAAO,EAAE,UAAU,CAAC,CAAC,CAAC;IAClF,CAAC;IAED,OAAO,CAAC,OAAO,GAAG,SAAS,CAAC,OAAO,CAAC;IAEpC,SAAS,CAAC,IAAI,CAAC;QACb,GAAG;QACH,iBAAiB;QACjB,OAAO;QACP,QAAQ,EAAE,iBAAiB,CAAC,SAAS,CAAC,OAAkB,EAAE,UAAU,CAAC;QACrE,YAAY;QACZ,aAAa;QACb,YAAY,EAAE,MAAM;QACpB,YAAY;KACb,CAAC,CAAC;AACL,CAAC","sourcesContent":["import { BIP32Interface } from 'bip32';\n\nimport { Transaction, taproot, TxOutput, ScriptSignature } from 'bitcoinjs-lib';\n\nimport { UtxoTransaction } from './UtxoTransaction';\nimport { UtxoTransactionBuilder } from './UtxoTransactionBuilder';\nimport {\n  createOutputScript2of3,\n  createOutputScriptP2shP2pk,\n  createSpendScriptP2tr,\n  getOutputScript,\n  ScriptType,\n  ScriptType2Of3,\n  scriptType2Of3AsPrevOutType,\n} from './outputScripts';\nimport { Triple } from './types';\nimport { getMainnet, Network, networks } from '../networks';\nimport { ecc as eccLib } from '../noble_ecc';\nimport { parseSignatureScript2Of3 } from './parseInput';\nimport { getTaprootOutputKey } from '../taproot';\n\n/**\n * Constraints for signature verifications.\n * Parameters are conjunctive: if multiple parameters are set, a verification for an individual\n * signature must satisfy all of them.\n */\nexport type VerificationSettings = {\n  /**\n   * The index of the signature to verify. Only iterates over non-empty signatures.\n   */\n  signatureIndex?: number;\n  /**\n   * The public key to verify.\n   */\n  publicKey?: Buffer;\n};\n\n/**\n * Result for a individual signature verification\n */\nexport type SignatureVerification =\n  | {\n      /** Set to the public key that signed for the signature */\n      signedBy: Buffer;\n      /** Set to the signature buffer */\n      signature: Buffer;\n    }\n  | { signedBy: undefined; signature: undefined };\n\n/**\n * @deprecated - use {@see verifySignaturesWithPublicKeys} instead\n * Get signature verifications for multsig transaction\n * @param transaction\n * @param inputIndex\n * @param amount - must be set for segwit transactions and BIP143 transactions\n * @param verificationSettings\n * @param prevOutputs - must be set for p2tr and p2trMusig2 transactions\n * @returns SignatureVerification[] - in order of parsed non-empty signatures\n */\nexport function getSignatureVerifications<TNumber extends number | bigint>(\n  transaction: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  amount: TNumber,\n  verificationSettings: VerificationSettings = {},\n  prevOutputs?: TxOutput<TNumber>[]\n): SignatureVerification[] {\n  /* istanbul ignore next */\n  if (!transaction.ins) {\n    throw new Error(`invalid transaction`);\n  }\n\n  const input = transaction.ins[inputIndex];\n  /* istanbul ignore next */\n  if (!input) {\n    throw new Error(`no input at index ${inputIndex}`);\n  }\n\n  if ((!input.script || input.script.length === 0) && input.witness.length === 0) {\n    // Unsigned input: no signatures.\n    return [];\n  }\n\n  const parsedScript = parseSignatureScript2Of3(input);\n\n  if (parsedScript.scriptType === 'taprootKeyPathSpend' || parsedScript.scriptType === 'taprootScriptPathSpend') {\n    if (\n      parsedScript.scriptType === 'taprootKeyPathSpend' &&\n      (verificationSettings.signatureIndex || verificationSettings.publicKey)\n    ) {\n      throw new Error(`signatureIndex and publicKey parameters not supported for taprootKeyPathSpend`);\n    }\n\n    if (verificationSettings.signatureIndex !== undefined) {\n      throw new Error(`signatureIndex parameter not supported for taprootScriptPathSpend`);\n    }\n\n    if (!prevOutputs) {\n      throw new Error(`prevOutputs not set`);\n    }\n\n    if (prevOutputs.length !== transaction.ins.length) {\n      throw new Error(`prevOutputs length ${prevOutputs.length}, expected ${transaction.ins.length}`);\n    }\n  }\n\n  if (\n    parsedScript.scriptType !== 'taprootKeyPathSpend' &&\n    parsedScript.scriptType !== 'taprootScriptPathSpend' &&\n    prevOutputs\n  ) {\n    const prevOutScript = prevOutputs[inputIndex].script;\n\n    const output = getOutputScript(parsedScript.scriptType, parsedScript.pubScript);\n    if (!prevOutScript.equals(output)) {\n      throw new Error(\n        `prevout script ${prevOutScript.toString('hex')} does not match computed script ${output.toString('hex')}`\n      );\n    }\n  }\n\n  let publicKeys: Buffer[];\n  if (parsedScript.scriptType === 'taprootKeyPathSpend') {\n    if (!prevOutputs) {\n      throw new Error(`prevOutputs not set`);\n    }\n    publicKeys = [getTaprootOutputKey(prevOutputs[inputIndex].script)];\n  } else {\n    publicKeys = parsedScript.publicKeys.filter(\n      (buf) =>\n        verificationSettings.publicKey === undefined ||\n        verificationSettings.publicKey.equals(buf) ||\n        verificationSettings.publicKey.slice(1).equals(buf)\n    );\n  }\n\n  const signatures = parsedScript.signatures\n    .filter((s) => s && s.length)\n    .filter((s, i) => verificationSettings.signatureIndex === undefined || verificationSettings.signatureIndex === i);\n\n  return signatures.map((signatureBuffer): SignatureVerification => {\n    if (signatureBuffer === 0 || signatureBuffer.length === 0) {\n      return { signedBy: undefined, signature: undefined };\n    }\n\n    let hashType = Transaction.SIGHASH_DEFAULT;\n\n    if (signatureBuffer.length === 65) {\n      hashType = signatureBuffer[signatureBuffer.length - 1];\n      signatureBuffer = signatureBuffer.slice(0, -1);\n    }\n\n    if (parsedScript.scriptType === 'taprootScriptPathSpend') {\n      if (!prevOutputs) {\n        throw new Error(`prevOutputs not set`);\n      }\n      const { controlBlock, pubScript } = parsedScript;\n      const leafHash = taproot.getTapleafHash(eccLib, controlBlock, pubScript);\n      const signatureHash = transaction.hashForWitnessV1(\n        inputIndex,\n        prevOutputs.map(({ script }) => script),\n        prevOutputs.map(({ value }) => value),\n        hashType,\n        leafHash\n      );\n\n      const signedBy = publicKeys.filter(\n        (k) => Buffer.isBuffer(signatureBuffer) && eccLib.verifySchnorr(signatureHash, k, signatureBuffer)\n      );\n\n      if (signedBy.length === 0) {\n        return { signedBy: undefined, signature: undefined };\n      }\n      if (signedBy.length === 1) {\n        return { signedBy: signedBy[0], signature: signatureBuffer };\n      }\n      throw new Error(`illegal state: signed by multiple public keys`);\n    } else if (parsedScript.scriptType === 'taprootKeyPathSpend') {\n      if (!prevOutputs) {\n        throw new Error(`prevOutputs not set`);\n      }\n      const signatureHash = transaction.hashForWitnessV1(\n        inputIndex,\n        prevOutputs.map(({ script }) => script),\n        prevOutputs.map(({ value }) => value),\n        hashType\n      );\n      const result = eccLib.verifySchnorr(signatureHash, publicKeys[0], signatureBuffer);\n      return result\n        ? { signedBy: publicKeys[0], signature: signatureBuffer }\n        : { signedBy: undefined, signature: undefined };\n    } else {\n      // slice the last byte from the signature hash input because it's the hash type\n      const { signature, hashType } = ScriptSignature.decode(signatureBuffer);\n      const transactionHash =\n        parsedScript.scriptType === 'p2shP2wsh' || parsedScript.scriptType === 'p2wsh'\n          ? transaction.hashForWitnessV0(inputIndex, parsedScript.pubScript, amount, hashType)\n          : transaction.hashForSignatureByNetwork(inputIndex, parsedScript.pubScript, amount, hashType);\n      const signedBy = publicKeys.filter((publicKey) =>\n        eccLib.verify(\n          transactionHash,\n          publicKey,\n          signature,\n          /*\n            Strict verification (require lower-S value), as required by BIP-0146\n            https://github.com/bitcoin/bips/blob/master/bip-0146.mediawiki\n            https://github.com/bitcoin-core/secp256k1/blob/ac83be33/include/secp256k1.h#L478-L508\n            https://github.com/bitcoinjs/tiny-secp256k1/blob/v1.1.6/js.js#L231-L233\n          */\n          true\n        )\n      );\n\n      if (signedBy.length === 0) {\n        return { signedBy: undefined, signature: undefined };\n      }\n      if (signedBy.length === 1) {\n        return { signedBy: signedBy[0], signature: signatureBuffer };\n      }\n      throw new Error(`illegal state: signed by multiple public keys`);\n    }\n  });\n}\n\n/**\n * @deprecated use {@see verifySignatureWithPublicKeys} instead\n * @param transaction\n * @param inputIndex\n * @param amount\n * @param verificationSettings - if publicKey is specified, returns true iff any signature is signed by publicKey.\n * @param prevOutputs - must be set for p2tr transactions\n */\nexport function verifySignature<TNumber extends number | bigint>(\n  transaction: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  amount: TNumber,\n  verificationSettings: VerificationSettings = {},\n  prevOutputs?: TxOutput<TNumber>[]\n): boolean {\n  const signatureVerifications = getSignatureVerifications(\n    transaction,\n    inputIndex,\n    amount,\n    verificationSettings,\n    prevOutputs\n  ).filter(\n    (v) =>\n      // If no publicKey is set in verificationSettings, all signatures must be valid.\n      // Otherwise, a single valid signature by the specified pubkey is sufficient.\n      verificationSettings.publicKey === undefined ||\n      (v.signedBy !== undefined &&\n        (verificationSettings.publicKey.equals(v.signedBy) ||\n          verificationSettings.publicKey.slice(1).equals(v.signedBy)))\n  );\n\n  return signatureVerifications.length > 0 && signatureVerifications.every((v) => v.signedBy !== undefined);\n}\n\n/**\n * @param v\n * @param publicKey\n * @return true iff signature is by publicKey (or xonly variant of publicKey)\n */\nfunction isSignatureByPublicKey(v: SignatureVerification, publicKey: Buffer): boolean {\n  return (\n    !!v.signedBy &&\n    (v.signedBy.equals(publicKey) ||\n      /* for p2tr signatures, we pass the pubkey in 33-byte format recover it from the signature in 32-byte format */\n      (publicKey.length === 33 && isSignatureByPublicKey(v, publicKey.slice(1))))\n  );\n}\n\n/**\n * @param transaction\n * @param inputIndex\n * @param prevOutputs\n * @param publicKeys\n * @return array with signature corresponding to n-th key, undefined if no match found\n */\nexport function getSignaturesWithPublicKeys<TNumber extends number | bigint>(\n  transaction: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  prevOutputs: TxOutput<TNumber>[],\n  publicKeys: Buffer[]\n): Array<Buffer | undefined> {\n  if (transaction.ins.length !== prevOutputs.length) {\n    throw new Error(`input length must match prevOutputs length`);\n  }\n\n  const signatureVerifications = getSignatureVerifications(\n    transaction,\n    inputIndex,\n    prevOutputs[inputIndex].value,\n    {},\n    prevOutputs\n  );\n\n  return publicKeys.map((publicKey) => {\n    const v = signatureVerifications.find((v) => isSignatureByPublicKey(v, publicKey));\n    return v ? v.signature : undefined;\n  });\n}\n\n/**\n * @param transaction\n * @param inputIndex\n * @param prevOutputs - transaction outputs for inputs\n * @param publicKeys - public keys to check signatures for\n * @return array of booleans indicating a valid signature for every pubkey in _publicKeys_\n */\nexport function verifySignatureWithPublicKeys<TNumber extends number | bigint>(\n  transaction: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  prevOutputs: TxOutput<TNumber>[],\n  publicKeys: Buffer[]\n): boolean[] {\n  return getSignaturesWithPublicKeys(transaction, inputIndex, prevOutputs, publicKeys).map((s) => s !== undefined);\n}\n\n/**\n * Wrapper for {@see verifySignatureWithPublicKeys} for single pubkey\n * @param transaction\n * @param inputIndex\n * @param prevOutputs\n * @param publicKey\n * @return true iff signature is valid\n */\nexport function verifySignatureWithPublicKey<TNumber extends number | bigint>(\n  transaction: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  prevOutputs: TxOutput<TNumber>[],\n  publicKey: Buffer\n): boolean {\n  return verifySignatureWithPublicKeys(transaction, inputIndex, prevOutputs, [publicKey])[0];\n}\n\nexport function getDefaultSigHash(network: Network, scriptType?: ScriptType): number {\n  switch (getMainnet(network)) {\n    case networks.bitcoincash:\n    case networks.bitcoinsv:\n    case networks.bitcoingold:\n    case networks.ecash:\n      return Transaction.SIGHASH_ALL | UtxoTransaction.SIGHASH_FORKID;\n    default:\n      switch (scriptType) {\n        case 'p2tr':\n        case 'p2trMusig2':\n          return Transaction.SIGHASH_DEFAULT;\n        default:\n          return Transaction.SIGHASH_ALL;\n      }\n  }\n}\n\nexport function signInputP2shP2pk<TNumber extends number | bigint>(\n  txBuilder: UtxoTransactionBuilder<TNumber>,\n  vin: number,\n  keyPair: BIP32Interface\n): void {\n  const prevOutScriptType = 'p2sh-p2pk';\n  const { redeemScript, witnessScript } = createOutputScriptP2shP2pk(keyPair.publicKey);\n  keyPair.network = txBuilder.network;\n\n  txBuilder.sign({\n    vin,\n    prevOutScriptType,\n    keyPair,\n    hashType: getDefaultSigHash(txBuilder.network as Network),\n    redeemScript,\n    witnessScript,\n    witnessValue: undefined,\n  });\n}\n\nexport function signInput2Of3<TNumber extends number | bigint>(\n  txBuilder: UtxoTransactionBuilder<TNumber>,\n  vin: number,\n  scriptType: ScriptType2Of3,\n  pubkeys: Triple<Buffer>,\n  keyPair: BIP32Interface,\n  cosigner: Buffer,\n  amount: TNumber\n): void {\n  let controlBlock;\n  let redeemScript;\n  let witnessScript;\n\n  const prevOutScriptType = scriptType2Of3AsPrevOutType(scriptType);\n  if (scriptType === 'p2tr') {\n    ({ witnessScript, controlBlock } = createSpendScriptP2tr(pubkeys, [keyPair.publicKey, cosigner]));\n  } else {\n    ({ redeemScript, witnessScript } = createOutputScript2of3(pubkeys, scriptType));\n  }\n\n  keyPair.network = txBuilder.network;\n\n  txBuilder.sign({\n    vin,\n    prevOutScriptType,\n    keyPair,\n    hashType: getDefaultSigHash(txBuilder.network as Network, scriptType),\n    redeemScript,\n    witnessScript,\n    witnessValue: amount,\n    controlBlock,\n  });\n}\n"]}
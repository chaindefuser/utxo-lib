{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/Unspent.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/Unspent.ts"],"names":[],"mappings":"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","sourcesContent":["import { getMainnet, Network, networks } from '../..';\nimport { UtxoTransactionBuilder } from '../UtxoTransactionBuilder';\nimport {\n  createKeyPathP2trMusig2,\n  createOutputScript2of3,\n  createSpendScriptP2tr,\n  createSpendScriptP2trMusig2,\n  scriptTypeForChain,\n  toXOnlyPublicKey,\n} from '../outputScripts';\nimport { toOutputScript } from '../../address';\nimport {\n  getDefaultSigHash,\n  getSignatureVerifications,\n  signInput2Of3,\n  verifySignatureWithPublicKeys,\n} from '../signature';\nimport { WalletUnspentSigner } from './WalletUnspentSigner';\nimport { KeyName, RootWalletKeys } from './WalletKeys';\nimport { UtxoTransaction } from '../UtxoTransaction';\nimport { Triple } from '../types';\nimport {\n  toOutput,\n  UnspentWithPrevTx,\n  Unspent,\n  isUnspentWithPrevTx,\n  toPrevOutput,\n  parseOutputId,\n  getOutputIdForInput,\n} from '../Unspent';\nimport { ChainCode, isSegwit } from './chains';\nimport { UtxoPsbt } from '../UtxoPsbt';\nimport { encodePsbtMusig2Participants } from '../Musig2';\nimport { createTransactionFromBuffer } from '../transaction';\nimport { parseSignatureScript } from '../parseInput';\nimport { checkForInput } from 'bip174/src/lib/utils';\nimport { ProprietaryKeySubtype, PSBT_PROPRIETARY_IDENTIFIER } from '../PsbtUtil';\n\n/** Final (non-replaceable) */\nexport const TX_INPUT_SEQUENCE_NUMBER_FINAL = 0xffffffff;\n\n/** Non-Final (Replaceable)\n * Reference: https://github.com/bitcoin/bitcoin/blob/v25.1/src/rpc/rawtransaction_util.cpp#L49\n * */\nexport const MAX_BIP125_RBF_SEQUENCE = 0xffffffff - 2;\n\nexport interface WalletUnspent<TNumber extends number | bigint = number> extends Unspent<TNumber> {\n  chain: ChainCode;\n  index: number;\n}\n\nexport interface NonWitnessWalletUnspent<TNumber extends number | bigint = number>\n  extends UnspentWithPrevTx<TNumber>,\n    WalletUnspent<TNumber> {}\n\nexport function isWalletUnspent<TNumber extends number | bigint>(u: Unspent<TNumber>): u is WalletUnspent<TNumber> {\n  return (u as WalletUnspent<TNumber>).chain !== undefined;\n}\n\nexport function signInputWithUnspent<TNumber extends number | bigint>(\n  txBuilder: UtxoTransactionBuilder<TNumber>,\n  inputIndex: number,\n  unspent: WalletUnspent<TNumber>,\n  unspentSigner: WalletUnspentSigner<RootWalletKeys>\n): void {\n  const { walletKeys, signer, cosigner } = unspentSigner.deriveForChainAndIndex(unspent.chain, unspent.index);\n  const scriptType = scriptTypeForChain(unspent.chain);\n  const pubScript = createOutputScript2of3(walletKeys.publicKeys, scriptType).scriptPubKey;\n  const pubScriptExpected = toOutputScript(unspent.address, txBuilder.network as Network);\n  if (!pubScript.equals(pubScriptExpected)) {\n    throw new Error(\n      `pubscript mismatch: expected ${pubScriptExpected.toString('hex')} got ${pubScript.toString('hex')}`\n    );\n  }\n  signInput2Of3<TNumber>(\n    txBuilder,\n    inputIndex,\n    scriptType,\n    walletKeys.publicKeys,\n    signer,\n    cosigner.publicKey,\n    unspent.value\n  );\n}\n\n/**\n * @param tx\n * @param inputIndex\n * @param unspents\n * @param walletKeys\n * @return triple of booleans indicating a valid signature for each pubkey\n */\nexport function verifySignatureWithUnspent<TNumber extends number | bigint>(\n  tx: UtxoTransaction<TNumber>,\n  inputIndex: number,\n  unspents: Unspent<TNumber>[],\n  walletKeys: RootWalletKeys\n): Triple<boolean> {\n  if (tx.ins.length !== unspents.length) {\n    throw new Error(`input length must match unspents length`);\n  }\n\n  const input = tx.ins[inputIndex];\n  /* istanbul ignore next */\n  if (!input) {\n    throw new Error(`no input at index ${inputIndex}`);\n  }\n\n  const unspent = unspents[inputIndex];\n  if (!isWalletUnspent(unspent) || (!input.script?.length && !input.witness?.length)) {\n    return [false, false, false];\n  }\n\n  const parsedInput = parseSignatureScript(input);\n  const prevOutputs = unspents.map((u) => toOutput(u, tx.network));\n\n  // If it is a taproot keyPathSpend input, the only valid signature combinations is user-bitgo. We can\n  // only verify that the aggregated signature is valid, not that the individual partial-signature is valid.\n  // Therefore, we can only say that either all partial signatures are valid, or none are.\n  if (parsedInput.scriptType === 'taprootKeyPathSpend') {\n    const result = getSignatureVerifications(tx, inputIndex, unspent.value, undefined, prevOutputs);\n    return result.length === 1 && result[0].signature ? [true, false, true] : [false, false, false];\n  }\n\n  return verifySignatureWithPublicKeys(\n    tx,\n    inputIndex,\n    prevOutputs,\n    walletKeys.deriveForChainAndIndex(unspent.chain, unspent.index).publicKeys\n  ) as Triple<boolean>;\n}\n\n/**\n * @deprecated\n * Used in certain legacy signing methods that do not derive signing data from index/chain\n */\nexport interface WalletUnspentLegacy<TNumber extends number | bigint = number> extends WalletUnspent<TNumber> {\n  /** @deprecated - obviated by signWithUnspent */\n  redeemScript?: string;\n  /** @deprecated - obviated by verifyWithUnspent */\n  witnessScript?: string;\n}\n\n/**\n * @param psbt\n * @param inputIndex\n * @param id Unspent ID\n * @returns true iff the unspent ID on the unspent and psbt input match\n */\nexport function psbtIncludesUnspentAtIndex(psbt: UtxoPsbt, inputIndex: number, id: string): boolean {\n  checkForInput(psbt.data.inputs, inputIndex);\n\n  const { txid, vout } = parseOutputId(id);\n  const psbtOutPoint = getOutputIdForInput(psbt.txInputs[inputIndex]);\n  return psbtOutPoint.txid === txid && psbtOutPoint.vout === vout;\n}\n\n/**\n * Update the psbt input at the given index\n * @param psbt\n * @param inputIndex\n * @param u\n * @param redeemScript Only overrides if there is no redeemScript in the input currently\n */\nexport function updateReplayProtectionUnspentToPsbt(\n  psbt: UtxoPsbt,\n  inputIndex: number,\n  u: Unspent<bigint>,\n  redeemScript?: Buffer,\n  customParams?: { skipNonWitnessUtxo?: boolean }\n): void {\n  if (!psbtIncludesUnspentAtIndex(psbt, inputIndex, u.id)) {\n    throw new Error(`unspent does not correspond to psbt input`);\n  }\n  const input = checkForInput(psbt.data.inputs, inputIndex);\n\n  if (redeemScript && !input.redeemScript) {\n    psbt.updateInput(inputIndex, { redeemScript });\n  }\n\n  // Because Zcash directly hashes the value for non-segwit transactions, we do not need to check indirectly\n  // with the previous transaction. Therefore, we can treat Zcash non-segwit transactions as Bitcoin\n  // segwit transactions\n  const isZcash = getMainnet(psbt.network) === networks.zcash;\n  if (!isUnspentWithPrevTx(u) && !isZcash && !customParams?.skipNonWitnessUtxo) {\n    throw new Error('Error, require previous tx to add to PSBT');\n  }\n  if ((isZcash && !input.witnessUtxo) || customParams?.skipNonWitnessUtxo) {\n    const { script, value } = toPrevOutput(u, psbt.network);\n    psbt.updateInput(inputIndex, { witnessUtxo: { script, value } });\n  } else if (!isZcash && !input.nonWitnessUtxo) {\n    psbt.updateInput(inputIndex, { nonWitnessUtxo: (u as UnspentWithPrevTx<bigint>).prevTx });\n  }\n\n  const sighashType = getDefaultSigHash(psbt.network);\n  if (psbt.data.inputs[inputIndex].sighashType === undefined) {\n    psbt.updateInput(inputIndex, { sighashType });\n  }\n}\n\nfunction addUnspentToPsbt(\n  psbt: UtxoPsbt,\n  id: string,\n  { sequenceNumber = TX_INPUT_SEQUENCE_NUMBER_FINAL }: { sequenceNumber?: number } = {}\n): void {\n  const { txid, vout } = parseOutputId(id);\n  psbt.addInput({\n    hash: txid,\n    index: vout,\n    sequence: sequenceNumber,\n  });\n}\n\nexport function addReplayProtectionUnspentToPsbt(\n  psbt: UtxoPsbt,\n  u: Unspent<bigint>,\n  redeemScript: Buffer,\n  customParams?: { skipNonWitnessUtxo?: boolean }\n): void {\n  addUnspentToPsbt(psbt, u.id);\n  updateReplayProtectionUnspentToPsbt(psbt, psbt.inputCount - 1, u, redeemScript, customParams);\n}\n\n/**\n * Update the PSBT with the unspent data for the input at the given index if the data is not there already.\n *\n * If skipNonWitnessUtxo is true, then the nonWitnessUtxo will not be added for an input that requires it (e.g. non-segwit)\n * and instead the witnessUtxo will be added\n *\n * @param psbt\n * @param inputIndex\n * @param u\n * @param rootWalletKeys\n * @param signer\n * @param cosigner\n * @param customParams\n */\nexport function updateWalletUnspentForPsbt(\n  psbt: UtxoPsbt,\n  inputIndex: number,\n  u: WalletUnspent<bigint>,\n  rootWalletKeys: RootWalletKeys,\n  signer: KeyName,\n  cosigner: KeyName,\n  customParams?: { skipNonWitnessUtxo?: boolean }\n): void {\n  if (!psbtIncludesUnspentAtIndex(psbt, inputIndex, u.id)) {\n    throw new Error(`unspent does not correspond to psbt input`);\n  }\n  const input = checkForInput(psbt.data.inputs, inputIndex);\n\n  // Because Zcash directly hashes the value for non-segwit transactions, we do not need to check indirectly\n  // with the previous transaction. Therefore, we can treat Zcash non-segwit transactions as Bitcoin\n  // segwit transactions\n  const isZcashOrSegwit = isSegwit(u.chain) || getMainnet(psbt.network) === networks.zcash;\n  if ((isZcashOrSegwit || customParams?.skipNonWitnessUtxo) && !input.witnessUtxo) {\n    const { script, value } = toPrevOutput(u, psbt.network);\n    psbt.updateInput(inputIndex, { witnessUtxo: { script, value } });\n  } else if (!isZcashOrSegwit) {\n    if (!isUnspentWithPrevTx(u)) {\n      throw new Error('Error, require previous tx to add to PSBT');\n    }\n\n    if (!input.witnessUtxo && !input.nonWitnessUtxo) {\n      // Force the litecoin transaction to have no MWEB advanced transaction flag\n      if (getMainnet(psbt.network) === networks.litecoin) {\n        u.prevTx = createTransactionFromBuffer(u.prevTx, psbt.network, { amountType: 'bigint' }).toBuffer();\n      }\n\n      psbt.updateInput(inputIndex, { nonWitnessUtxo: u.prevTx });\n    }\n  }\n\n  const walletKeys = rootWalletKeys.deriveForChainAndIndex(u.chain, u.index);\n  const scriptType = scriptTypeForChain(u.chain);\n  const sighashType = getDefaultSigHash(psbt.network, scriptType);\n  if (psbt.data.inputs[inputIndex].sighashType === undefined) {\n    psbt.updateInput(inputIndex, { sighashType });\n  }\n  const isBackupFlow = signer === 'backup' || cosigner === 'backup';\n\n  if (scriptType === 'p2tr' || (scriptType === 'p2trMusig2' && isBackupFlow)) {\n    if (input.tapLeafScript && input.tapBip32Derivation) {\n      return;\n    }\n    const createSpendScriptP2trFn = scriptType === 'p2tr' ? createSpendScriptP2tr : createSpendScriptP2trMusig2;\n    const { controlBlock, witnessScript, leafVersion, leafHash } = createSpendScriptP2trFn(walletKeys.publicKeys, [\n      walletKeys[signer].publicKey,\n      walletKeys[cosigner].publicKey,\n    ]);\n    if (!input.tapLeafScript) {\n      psbt.updateInput(inputIndex, {\n        tapLeafScript: [{ controlBlock, script: witnessScript, leafVersion }],\n      });\n    }\n    if (!input.tapBip32Derivation) {\n      psbt.updateInput(inputIndex, {\n        tapBip32Derivation: [signer, cosigner].map((key) => ({\n          leafHashes: [leafHash],\n          pubkey: toXOnlyPublicKey(walletKeys[key].publicKey),\n          path: rootWalletKeys.getDerivationPath(rootWalletKeys[key], u.chain, u.index),\n          masterFingerprint: rootWalletKeys[key].fingerprint,\n        })),\n      });\n    }\n  } else if (scriptType === 'p2trMusig2') {\n    const {\n      internalPubkey: tapInternalKey,\n      outputPubkey: tapOutputKey,\n      taptreeRoot,\n    } = createKeyPathP2trMusig2(walletKeys.publicKeys);\n\n    if (\n      psbt.getProprietaryKeyVals(inputIndex, {\n        identifier: PSBT_PROPRIETARY_IDENTIFIER,\n        subtype: ProprietaryKeySubtype.MUSIG2_PARTICIPANT_PUB_KEYS,\n      }).length === 0\n    ) {\n      const participantsKeyValData = encodePsbtMusig2Participants({\n        tapOutputKey,\n        tapInternalKey,\n        participantPubKeys: [walletKeys.user.publicKey, walletKeys.bitgo.publicKey],\n      });\n      psbt.addProprietaryKeyValToInput(inputIndex, participantsKeyValData);\n    }\n\n    if (!input.tapInternalKey) {\n      psbt.updateInput(inputIndex, {\n        tapInternalKey: tapInternalKey,\n      });\n    }\n\n    if (!input.tapMerkleRoot) {\n      psbt.updateInput(inputIndex, {\n        tapMerkleRoot: taptreeRoot,\n      });\n    }\n\n    if (!input.tapBip32Derivation) {\n      psbt.updateInput(inputIndex, {\n        tapBip32Derivation: [signer, cosigner].map((key) => ({\n          leafHashes: [],\n          pubkey: toXOnlyPublicKey(walletKeys[key].publicKey),\n          path: rootWalletKeys.getDerivationPath(rootWalletKeys[key], u.chain, u.index),\n          masterFingerprint: rootWalletKeys[key].fingerprint,\n        })),\n      });\n    }\n  } else {\n    if (!input.bip32Derivation) {\n      psbt.updateInput(inputIndex, {\n        bip32Derivation: [0, 1, 2].map((idx) => ({\n          pubkey: walletKeys.triple[idx].publicKey,\n          path: walletKeys.paths[idx],\n          masterFingerprint: rootWalletKeys.triple[idx].fingerprint,\n        })),\n      });\n    }\n\n    const { witnessScript, redeemScript } = createOutputScript2of3(walletKeys.publicKeys, scriptType);\n    if (witnessScript && !input.witnessScript) {\n      psbt.updateInput(inputIndex, { witnessScript });\n    }\n    if (redeemScript && !input.redeemScript) {\n      psbt.updateInput(inputIndex, { redeemScript });\n    }\n  }\n}\n\nexport function addWalletUnspentToPsbt(\n  psbt: UtxoPsbt,\n  u: WalletUnspent<bigint>,\n  rootWalletKeys: RootWalletKeys,\n  signer: KeyName,\n  cosigner: KeyName,\n  customParams?: { isReplaceableByFee?: boolean; skipNonWitnessUtxo?: boolean }\n): void {\n  let sequenceNumber = TX_INPUT_SEQUENCE_NUMBER_FINAL;\n  if (customParams && customParams.isReplaceableByFee) {\n    sequenceNumber = MAX_BIP125_RBF_SEQUENCE;\n  }\n\n  addUnspentToPsbt(psbt, u.id, { sequenceNumber });\n  updateWalletUnspentForPsbt(\n    psbt,\n    psbt.inputCount - 1,\n    u,\n    rootWalletKeys,\n    signer,\n    cosigner,\n    customParams ? { skipNonWitnessUtxo: customParams.skipNonWitnessUtxo } : {}\n  );\n}\n"]}
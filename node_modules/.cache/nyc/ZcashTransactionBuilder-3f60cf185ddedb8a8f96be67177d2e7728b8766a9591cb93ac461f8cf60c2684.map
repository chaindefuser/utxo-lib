{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/zcash/ZcashTransactionBuilder.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/zcash/ZcashTransactionBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import * as bitcoinjs from 'bitcoinjs-lib';\nimport * as types from 'bitcoinjs-lib/src/types';\nconst typeforce = require('typeforce');\n\nimport { Network } from '../..';\nimport {\n  getDefaultConsensusBranchIdForVersion,\n  getDefaultVersionGroupIdForVersion,\n  ZcashNetwork,\n  ZcashTransaction,\n} from './ZcashTransaction';\nimport { UtxoTransactionBuilder } from '../UtxoTransactionBuilder';\nimport { toOutputScript } from './address';\n\nexport class ZcashTransactionBuilder<TNumber extends number | bigint = number> extends UtxoTransactionBuilder<\n  TNumber,\n  ZcashTransaction<TNumber>\n> {\n  constructor(network: ZcashNetwork) {\n    super(network);\n  }\n\n  protected createInitialTransaction(network: Network): ZcashTransaction<TNumber> {\n    return new ZcashTransaction<TNumber>(network as ZcashNetwork);\n  }\n\n  static fromTransaction<TNumber extends number | bigint = number>(\n    transaction: ZcashTransaction<TNumber>,\n    network?: Network,\n    prevOutput?: bitcoinjs.TxOutput<TNumber>[]\n  ): ZcashTransactionBuilder<TNumber> {\n    const txb = new ZcashTransactionBuilder<TNumber>(transaction.network);\n\n    // Copy transaction fields\n    txb.setVersion(transaction.version, !!transaction.overwintered);\n    txb.setLockTime(transaction.locktime);\n\n    // Copy Zcash overwinter fields. Omitted if the transaction builder is not for Zcash.\n    if (txb.tx.isOverwinterCompatible()) {\n      txb.setVersionGroupId(transaction.versionGroupId);\n      txb.setExpiryHeight(transaction.expiryHeight);\n    }\n\n    txb.setConsensusBranchId(transaction.consensusBranchId);\n\n    // Copy outputs (done first to avoid signature invalidation)\n    transaction.outs.forEach(function (txOut) {\n      txb.addOutput(txOut.script, txOut.value);\n    });\n\n    // Copy inputs\n    transaction.ins.forEach(function (txIn) {\n      (txb as any).__addInputUnsafe(txIn.hash, txIn.index, {\n        sequence: txIn.sequence,\n        script: txIn.script,\n        witness: txIn.witness,\n        value: (txIn as any).value,\n      });\n    });\n\n    return txb;\n  }\n\n  setVersion(version: number, overwinter = true): void {\n    typeforce(types.UInt32, version);\n    this.tx.overwintered = overwinter ? 1 : 0;\n    this.tx.version = version;\n  }\n\n  setDefaultsForVersion(network: Network, version: number): void {\n    switch (version) {\n      case 4:\n      case ZcashTransaction.VERSION4_BRANCH_CANOPY:\n      case ZcashTransaction.VERSION4_BRANCH_NU5:\n      case ZcashTransaction.VERSION4_BRANCH_NU6:\n        this.setVersion(4);\n        break;\n      case 5:\n      case ZcashTransaction.VERSION5_BRANCH_NU5:\n      case ZcashTransaction.VERSION5_BRANCH_NU6:\n        this.setVersion(5);\n        break;\n      default:\n        throw new Error(`invalid version ${version}`);\n    }\n\n    this.tx.versionGroupId = getDefaultVersionGroupIdForVersion(version);\n    this.tx.consensusBranchId = getDefaultConsensusBranchIdForVersion(network, version);\n  }\n\n  private hasSignatures(): boolean {\n    return (this as any).__INPUTS.some(function (input: { signatures: unknown }) {\n      return input.signatures !== undefined;\n    });\n  }\n\n  private setPropertyCheckSignatures(propName: keyof ZcashTransaction<TNumber>, value: unknown) {\n    if (this.tx[propName] === value) {\n      return;\n    }\n    if (this.hasSignatures()) {\n      throw new Error(`Changing property ${propName} for a partially signed transaction would invalidate signatures`);\n    }\n    this.tx[propName] = value as any;\n  }\n\n  setConsensusBranchId(consensusBranchId: number): void {\n    typeforce(types.UInt32, consensusBranchId);\n    this.setPropertyCheckSignatures('consensusBranchId', consensusBranchId);\n  }\n\n  setVersionGroupId(versionGroupId: number): void {\n    typeforce(types.UInt32, versionGroupId);\n    this.setPropertyCheckSignatures('versionGroupId', versionGroupId);\n  }\n\n  setExpiryHeight(expiryHeight: number): void {\n    typeforce(types.UInt32, expiryHeight);\n    this.setPropertyCheckSignatures('expiryHeight', expiryHeight);\n  }\n\n  build(): ZcashTransaction<TNumber> {\n    return super.build() as ZcashTransaction<TNumber>;\n  }\n\n  buildIncomplete(): ZcashTransaction<TNumber> {\n    return super.buildIncomplete() as ZcashTransaction<TNumber>;\n  }\n\n  addOutput(scriptPubKey: string | Buffer, value: TNumber): number {\n    // Attempt to get a script if it's a base58 or bech32 address string\n    if (typeof scriptPubKey === 'string') {\n      scriptPubKey = toOutputScript(scriptPubKey, this.network as Network);\n    }\n\n    return super.addOutput(scriptPubKey, value);\n  }\n}\n"]}
{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/Unspent.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/Unspent.ts"],"names":[],"mappings":";;AA8BA,kDAIC;AAKD,4BAKC;AAKD,gCAaC;AAED,oDAQC;AAMD,sCAcC;AAOD,wCAEC;AAED,kDAKC;AAsBD,oCAQC;AAKD,wDAiBC;AAOD,0DAOC;AASD,gCAaC;AAlMD,wCAA8D;AA4B9D,SAAgB,mBAAmB,CACjC,CAAmB;IAEnB,OAAO,MAAM,CAAC,QAAQ,CAAE,CAAgC,CAAC,MAAM,CAAC,CAAC;AACnE,CAAC;AAED;;GAEG;AACH,SAAgB,QAAQ,CAAkC,CAAmB,EAAE,OAAgB;IAC7F,OAAO;QACL,MAAM,EAAE,IAAA,wBAAc,EAAC,CAAC,CAAC,OAAO,EAAE,OAAO,CAAC;QAC1C,KAAK,EAAE,CAAC,CAAC,KAAK;KACf,CAAC;AACJ,CAAC;AAED;;GAEG;AACH,SAAgB,UAAU,CACxB,EAA4B,EAC5B,IAAY;IAEZ,MAAM,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACxB,IAAI,CAAC,CAAC,EAAE,CAAC;QACP,MAAM,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC;IAClC,CAAC;IACD,OAAO;QACL,EAAE,EAAE,cAAc,CAAC,EAAE,IAAI,EAAE,EAAE,CAAC,KAAK,EAAE,EAAE,IAAI,EAAE,CAAC;QAC9C,OAAO,EAAE,IAAA,0BAAgB,EAAC,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,OAAO,CAAC;QAC/C,KAAK,EAAE,CAAC,CAAC,KAAK;KACf,CAAC;AACJ,CAAC;AAED,SAAgB,oBAAoB,CAClC,EAA4B,EAC5B,IAAY;IAEZ,OAAO;QACL,GAAG,UAAU,CAAC,EAAE,EAAE,IAAI,CAAC;QACvB,MAAM,EAAE,EAAE,CAAC,QAAQ,EAAE;KACtB,CAAC;AACJ,CAAC;AAED;;;GAGG;AACH,SAAgB,aAAa,CAAC,QAAgB;IAC5C,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAClC,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QACvB,MAAM,IAAI,KAAK,CAAC,8CAA8C,CAAC,CAAC;IAClE,CAAC;IACD,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,GAAG,KAAK,CAAC;IAC9B,MAAM,IAAI,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;IAC7B,IAAI,IAAI,CAAC,MAAM,KAAK,EAAE,EAAE,CAAC;QACvB,MAAM,IAAI,KAAK,CAAC,gBAAgB,IAAI,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC;IACzD,CAAC;IACD,IAAI,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,IAAI,CAAC,EAAE,CAAC;QAClE,MAAM,IAAI,KAAK,CAAC,oCAAoC,CAAC,CAAC;IACxD,CAAC;IACD,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;AACxB,CAAC;AAED;;;;GAIG;AACH,SAAgB,cAAc,CAAC,EAAE,IAAI,EAAE,IAAI,EAAc;IACvD,OAAO,GAAG,IAAI,IAAI,IAAI,EAAE,CAAC;AAC3B,CAAC;AAED,SAAgB,mBAAmB,CAAC,CAAkC;IACpE,OAAO;QACL,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC;QACnD,IAAI,EAAE,CAAC,CAAC,KAAK;KACd,CAAC;AACJ,CAAC;AAmBD;;GAEG;AACH,SAAgB,YAAY,CAC1B,CAAmB,EACnB,OAAgB;IAEhB,OAAO;QACL,GAAG,aAAa,CAAC,CAAC,CAAC,EAAE,CAAC;QACtB,GAAG,QAAQ,CAAC,CAAC,EAAE,OAAO,CAAC;KACxB,CAAC;AACJ,CAAC;AAED;;GAEG;AACH,SAAgB,sBAAsB,CACpC,CAA0C,EAC1C,OAAgB;IAEhB,IAAI,MAAM,CAAC;IACX,IAAI,OAAO,CAAC,CAAC,MAAM,KAAK,QAAQ,EAAE,CAAC;QACjC,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;IACxC,CAAC;SAAM,IAAI,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC;QACrC,MAAM,GAAG,CAAC,CAAC,MAAM,CAAC;IACpB,CAAC;SAAM,IAAI,CAAC,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;QAClC,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC;IACjE,CAAC;IACD,OAAO;QACL,GAAG,aAAa,CAAC,CAAC,CAAC,EAAE,CAAC;QACtB,GAAG,QAAQ,CAAC,CAAC,EAAE,OAAO,CAAC;QACvB,MAAM;KACP,CAAC;AACJ,CAAC;AAED;;;;GAIG;AACH,SAAgB,uBAAuB,CACrC,GAAoC,EACpC,CAAmB,EACnB,QAAiB;IAEjB,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,YAAY,CAAC,CAAC,EAAE,GAAG,CAAC,OAAkB,CAAC,CAAC;IAC9E,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC;AACpD,CAAC;AAED;;;;;;GAMG;AACH,SAAgB,UAAU,CACxB,QAA8B,EAC9B,aAAkC,QAAQ;IAE1C,IAAI,UAAU,KAAK,QAAQ,EAAE,CAAC;QAC5B,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAI,CAAC,CAAC,KAAgB,EAAE,MAAM,CAAC,CAAC,CAAC,CAAY,CAAC;IACtF,CAAC;SAAM,CAAC;QACN,MAAM,GAAG,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,GAAI,CAAC,CAAC,KAAgB,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9E,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,CAAC,EAAE,CAAC;YAC/B,MAAM,IAAI,KAAK,CAAC,iEAAiE,CAAC,CAAC;QACrF,CAAC;QACD,OAAO,GAAc,CAAC;IACxB,CAAC;AACH,CAAC","sourcesContent":["import { TxOutput } from 'bitcoinjs-lib';\nimport { Network } from '..';\nimport { fromOutputScript, toOutputScript } from '../address';\nimport { UtxoTransactionBuilder } from './UtxoTransactionBuilder';\nimport { UtxoTransaction } from './UtxoTransaction';\n\n/**\n * Public unspent data in BitGo-specific representation.\n */\nexport interface Unspent<TNumber extends number | bigint = number> {\n  /**\n   * Format: ${txid}:${vout}.\n   * Use `parseOutputId(id)` to parse.\n   */\n  id: string;\n  /**\n   * The network-specific encoded address.\n   * Use `toOutputScript(address, network)` to obtain scriptPubKey.\n   */\n  address: string;\n  /**\n   * The amount in satoshi.\n   */\n  value: TNumber;\n}\n\nexport interface UnspentWithPrevTx<TNumber extends number | bigint = number> extends Unspent<TNumber> {\n  prevTx: Buffer;\n}\n\nexport function isUnspentWithPrevTx<TNumber extends number | bigint, TUnspent extends Unspent<TNumber>>(\n  u: Unspent<TNumber>\n): u is TUnspent & { prevTx: Buffer } {\n  return Buffer.isBuffer((u as UnspentWithPrevTx<TNumber>).prevTx);\n}\n\n/**\n * @return TxOutput from Unspent\n */\nexport function toOutput<TNumber extends number | bigint>(u: Unspent<TNumber>, network: Network): TxOutput<TNumber> {\n  return {\n    script: toOutputScript(u.address, network),\n    value: u.value,\n  };\n}\n\n/**\n * @return Unspent from TxOutput\n */\nexport function fromOutput<TNumber extends number | bigint>(\n  tx: UtxoTransaction<TNumber>,\n  vout: number\n): Unspent<TNumber> {\n  const o = tx.outs[vout];\n  if (!o) {\n    throw new Error(`invalid vout`);\n  }\n  return {\n    id: formatOutputId({ txid: tx.getId(), vout }),\n    address: fromOutputScript(o.script, tx.network),\n    value: o.value,\n  };\n}\n\nexport function fromOutputWithPrevTx<TNumber extends number | bigint>(\n  tx: UtxoTransaction<TNumber>,\n  vout: number\n): UnspentWithPrevTx<TNumber> {\n  return {\n    ...fromOutput(tx, vout),\n    prevTx: tx.toBuffer(),\n  };\n}\n\n/**\n * @param outputId\n * @return TxOutPoint\n */\nexport function parseOutputId(outputId: string): TxOutPoint {\n  const parts = outputId.split(':');\n  if (parts.length !== 2) {\n    throw new Error(`invalid outputId, must have format txid:vout`);\n  }\n  const [txid, voutStr] = parts;\n  const vout = Number(voutStr);\n  if (txid.length !== 64) {\n    throw new Error(`invalid txid ${txid} ${txid.length}`);\n  }\n  if (Number.isNaN(vout) || vout < 0 || !Number.isSafeInteger(vout)) {\n    throw new Error(`invalid vout: must be integer >= 0`);\n  }\n  return { txid, vout };\n}\n\n/**\n * @param txid\n * @param vout\n * @return outputId\n */\nexport function formatOutputId({ txid, vout }: TxOutPoint): string {\n  return `${txid}:${vout}`;\n}\n\nexport function getOutputIdForInput(i: { hash: Buffer; index: number }): TxOutPoint {\n  return {\n    txid: Buffer.from(i.hash).reverse().toString('hex'),\n    vout: i.index,\n  };\n}\n\n/**\n * Reference to output of an existing transaction\n */\nexport type TxOutPoint = {\n  txid: string;\n  vout: number;\n};\n\n/**\n * Output reference and script data.\n * Suitable for use for `txb.addInput()`\n */\nexport type PrevOutput<TNumber extends number | bigint = number> = TxOutPoint &\n  TxOutput<TNumber> & {\n    prevTx?: Buffer;\n  };\n\n/**\n * @return PrevOutput from Unspent\n */\nexport function toPrevOutput<TNumber extends number | bigint>(\n  u: Unspent<TNumber>,\n  network: Network\n): PrevOutput<TNumber> {\n  return {\n    ...parseOutputId(u.id),\n    ...toOutput(u, network),\n  };\n}\n\n/**\n * @return PrevOutput with prevTx from Unspent\n */\nexport function toPrevOutputWithPrevTx<TNumber extends number | bigint>(\n  u: Unspent<TNumber> & { prevTx?: unknown },\n  network: Network\n): PrevOutput<TNumber> {\n  let prevTx;\n  if (typeof u.prevTx === 'string') {\n    prevTx = Buffer.from(u.prevTx, 'hex');\n  } else if (Buffer.isBuffer(u.prevTx)) {\n    prevTx = u.prevTx;\n  } else if (u.prevTx !== undefined) {\n    throw new Error(`Invalid prevTx type for unspent ${u.prevTx}`);\n  }\n  return {\n    ...parseOutputId(u.id),\n    ...toOutput(u, network),\n    prevTx,\n  };\n}\n\n/**\n * @param txb\n * @param u\n * @param sequence - sequenceId\n */\nexport function addToTransactionBuilder<TNumber extends number | bigint>(\n  txb: UtxoTransactionBuilder<TNumber>,\n  u: Unspent<TNumber>,\n  sequence?: number\n): void {\n  const { txid, vout, script, value } = toPrevOutput(u, txb.network as Network);\n  txb.addInput(txid, vout, sequence, script, value);\n}\n\n/**\n * Sum the values of the unspents.\n * Throws error if sum is not a safe integer value, or if unspent amount types do not match `amountType`\n * @param unspents - array of unspents to sum\n * @param amountType - expected value type of unspents\n * @return unspentSum - type matches amountType\n */\nexport function unspentSum<TNumber extends number | bigint>(\n  unspents: { value: TNumber }[],\n  amountType: 'number' | 'bigint' = 'number'\n): TNumber {\n  if (amountType === 'bigint') {\n    return unspents.reduce((sum, u) => sum + (u.value as bigint), BigInt(0)) as TNumber;\n  } else {\n    const sum = unspents.reduce((sum, u) => sum + (u.value as number), Number(0));\n    if (!Number.isSafeInteger(sum)) {\n      throw new Error('unspent sum is not a safe integer number, consider using bigint');\n    }\n    return sum as TNumber;\n  }\n}\n"]}
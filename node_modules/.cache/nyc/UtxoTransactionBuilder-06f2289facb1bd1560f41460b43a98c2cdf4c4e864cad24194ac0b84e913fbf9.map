{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/UtxoTransactionBuilder.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/UtxoTransactionBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import { TxOutput, Transaction } from 'bitcoinjs-lib';\n// eslint-disable-next-line\nimport * as bitcoinjs from 'bitcoinjs-lib';\nimport { Network } from '..';\nimport { Signer, TransactionBuilder } from '../transaction_builder';\nimport { UtxoTransaction } from './UtxoTransaction';\n\nexport interface TxbSignArg<TNumber extends number | bigint = number> {\n  prevOutScriptType: string;\n  vin: number;\n  keyPair: Signer;\n  redeemScript?: Buffer;\n  hashType?: number;\n  witnessValue?: TNumber;\n  witnessScript?: Buffer;\n  controlBlock?: Buffer;\n}\n\nexport class UtxoTransactionBuilder<\n  TNumber extends number | bigint = number,\n  T extends UtxoTransaction<TNumber> = UtxoTransaction<TNumber>\n> extends TransactionBuilder<TNumber> {\n  constructor(network: Network, tx?: UtxoTransaction<TNumber>) {\n    super();\n    this.network = network;\n    (this as any).__TX = this.createInitialTransaction(network, tx);\n  }\n\n  protected static newTransactionBuilder<TNumber extends number | bigint>(\n    network: Network,\n    tx: UtxoTransaction<TNumber>\n  ): UtxoTransactionBuilder<TNumber> {\n    return new UtxoTransactionBuilder<TNumber>(network, tx);\n  }\n\n  protected createInitialTransaction(network: Network, tx?: Transaction<TNumber>): UtxoTransaction<TNumber> {\n    return new UtxoTransaction<TNumber>(network, tx);\n  }\n\n  static fromTransaction<TNumber extends number | bigint = number>(\n    tx: UtxoTransaction<TNumber>,\n    network?: Network,\n    prevOutputs?: TxOutput<TNumber>[]\n  ): UtxoTransactionBuilder<TNumber> {\n    const txb = TransactionBuilder.fromTransaction<TNumber>(tx, network, prevOutputs);\n    const utxb = this.newTransactionBuilder<TNumber>(tx.network, tx);\n\n    (utxb as any).__INPUTS = (txb as any).__INPUTS;\n\n    if (prevOutputs) {\n      const txbInputs = (utxb as any).__INPUTS;\n      if (prevOutputs.length !== txbInputs.length) {\n        throw new Error(`prevOuts must match txbInput length`);\n      }\n      prevOutputs.forEach((o, i) => {\n        txbInputs[i].value = o.value;\n        txbInputs[i].prevOutScript = o.script;\n      });\n    }\n    return utxb;\n  }\n\n  get tx(): T {\n    return (this as any).__TX;\n  }\n\n  build(): T {\n    return super.build() as T;\n  }\n\n  buildIncomplete(): T {\n    return super.buildIncomplete() as T;\n  }\n\n  sign(\n    signParams: number | TxbSignArg<TNumber>,\n    keyPair?: Signer,\n    redeemScript?: Buffer,\n    hashType?: number,\n    witnessValue?: TNumber,\n    witnessScript?: Buffer\n  ): void {\n    // Regular bitcoin p2sh-p2ms inputs do not include the input amount (value) in the signature and\n    // thus do not require the parameter `value` to be set.\n    // For bitcoincash and bitcoinsv p2sh-p2ms inputs, the value parameter *is* required however.\n    // Since the `value` parameter is not passed to the legacy hashing method, we must store it\n    // on the transaction input object.\n\n    if (typeof signParams === 'number') {\n      if (typeof witnessValue === 'number' || typeof witnessValue === 'bigint') {\n        (this.tx.ins[signParams] as any).value = witnessValue;\n      }\n\n      return super.sign(signParams, keyPair, redeemScript, hashType, witnessValue, witnessScript);\n    }\n\n    if (signParams.witnessValue !== undefined) {\n      (this.tx.ins[signParams.vin] as any).value = signParams.witnessValue;\n    }\n    // When calling the sign method via TxbSignArg, the `value` parameter is actually not permitted\n    // to be set for p2sh-p2ms transactions.\n    if (signParams.prevOutScriptType === 'p2sh-p2ms') {\n      delete signParams.witnessValue;\n    }\n    return super.sign(signParams);\n  }\n}\n"]}
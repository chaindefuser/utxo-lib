{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/WalletOutput.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/wallet/WalletOutput.ts"],"names":[],"mappings":"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","sourcesContent":["import { taproot } from 'bitcoinjs-lib';\nimport { PsbtOutputUpdate } from 'bip174/src/lib/interfaces';\nimport { UtxoPsbt } from '../UtxoPsbt';\nimport { RootWalletKeys } from './WalletKeys';\nimport { ChainCode, scriptTypeForChain } from './chains';\nimport { createOutputScript2of3, createPaymentP2tr, createPaymentP2trMusig2, toXOnlyPublicKey } from '../outputScripts';\n\n/**\n * Add a verifiable wallet output to the PSBT. The output and all data\n * needed to verify it from public keys only are added to the PSBT.\n * Typically these are change outputs.\n *\n * @param psbt the PSBT to add change output to\n * @param rootWalletKeys keys that will be able to spend the output\n * @param chain chain code to use for deriving scripts (and to determine script\n *              type) chain is an API parameter in the BitGo API, and may be\n *              any valid ChainCode\n * @param index derivation index for the change address\n * @param value value of the change output\n */\nexport function addWalletOutputToPsbt(\n  psbt: UtxoPsbt,\n  rootWalletKeys: RootWalletKeys,\n  chain: ChainCode,\n  index: number,\n  value: bigint\n): void {\n  const walletKeys = rootWalletKeys.deriveForChainAndIndex(chain, index);\n  const scriptType = scriptTypeForChain(chain);\n  if (scriptType === 'p2tr' || scriptType === 'p2trMusig2') {\n    const payment =\n      scriptType === 'p2tr' ? createPaymentP2tr(walletKeys.publicKeys) : createPaymentP2trMusig2(walletKeys.publicKeys);\n    psbt.addOutput({ script: payment.output!, value });\n  } else {\n    const { scriptPubKey: script } = createOutputScript2of3(walletKeys.publicKeys, scriptType);\n    psbt.addOutput({ script, value });\n  }\n  updateWalletOutputForPsbt(psbt, rootWalletKeys, psbt.data.outputs.length - 1, chain, index);\n}\n\n/**\n * Update the wallet output with the required information when necessary. If the\n * information is there already, it will skip over it.\n *\n * This function assumes that the output script and value have already been set.\n *\n * @param psbt the PSBT to update change output at\n * @param rootWalletKeys keys that will be able to spend the output\n * @param outputIndex output index where to update the output\n * @param chain chain code to use for deriving scripts (and to determine script\n *              type) chain is an API parameter in the BitGo API, and may be\n *              any valid ChainCode\n * @param index derivation index for the change address\n * @param value value of the change output\n */\nexport function updateWalletOutputForPsbt(\n  psbt: UtxoPsbt,\n  rootWalletKeys: RootWalletKeys,\n  outputIndex: number,\n  chain: ChainCode,\n  index: number\n): void {\n  if (psbt.data.outputs.length <= outputIndex) {\n    throw new Error(\n      `outputIndex (${outputIndex}) is too large for the number of outputs (${psbt.data.outputs.length})`\n    );\n  }\n\n  const outputScript = psbt.getOutputScript(outputIndex);\n\n  const walletKeys = rootWalletKeys.deriveForChainAndIndex(chain, index);\n  const scriptType = scriptTypeForChain(chain);\n  const output = psbt.data.outputs[outputIndex];\n  const update: PsbtOutputUpdate = {};\n  if (scriptType === 'p2tr' || scriptType === 'p2trMusig2') {\n    const payment =\n      scriptType === 'p2tr' ? createPaymentP2tr(walletKeys.publicKeys) : createPaymentP2trMusig2(walletKeys.publicKeys);\n    if (!payment.output || !payment.output.equals(outputScript)) {\n      throw new Error(`cannot update a p2tr output where the scripts do not match - Failing.`);\n    }\n    const allLeafHashes = payment.redeems!.map((r) => taproot.hashTapLeaf(r.output!));\n\n    if (!output.tapTree) {\n      update.tapTree = payment.tapTree;\n    }\n    if (!output.tapInternalKey) {\n      update.tapInternalKey = payment.internalPubkey;\n    }\n    if (!output.tapBip32Derivation) {\n      update.tapBip32Derivation = [0, 1, 2].map((idx) => {\n        const pubkey = toXOnlyPublicKey(walletKeys.triple[idx].publicKey);\n        const leafHashes: Buffer[] = [];\n        payment.redeems!.forEach((r, idx) => {\n          if (r.pubkeys!.find((pk) => pk.equals(pubkey))) {\n            leafHashes.push(allLeafHashes[idx]);\n          }\n        });\n        return {\n          leafHashes,\n          pubkey,\n          path: walletKeys.paths[idx],\n          masterFingerprint: rootWalletKeys.triple[idx].fingerprint,\n        };\n      });\n    }\n  } else {\n    const { scriptPubKey, witnessScript, redeemScript } = createOutputScript2of3(walletKeys.publicKeys, scriptType);\n    if (!scriptPubKey.equals(outputScript)) {\n      throw new Error(`cannot update an output where the scripts do not match - Failing.`);\n    }\n    if (!output.bip32Derivation) {\n      update.bip32Derivation = [0, 1, 2].map((idx) => ({\n        pubkey: walletKeys.triple[idx].publicKey,\n        path: walletKeys.paths[idx],\n        masterFingerprint: rootWalletKeys.triple[idx].fingerprint,\n      }));\n    }\n    if (!output.witnessScript && witnessScript) {\n      update.witnessScript = witnessScript;\n    }\n    if (!output.redeemScript && redeemScript) {\n      update.redeemScript = redeemScript;\n    }\n  }\n  psbt.updateOutput(outputIndex, update);\n}\n"]}
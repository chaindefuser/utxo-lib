{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/zcash/ZcashPsbt.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/zcash/ZcashPsbt.ts"],"names":[],"mappings":"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","sourcesContent":["import { PsbtOpts, UtxoPsbt } from '../UtxoPsbt';\nimport {\n  getDefaultConsensusBranchIdForVersion,\n  getDefaultVersionGroupIdForVersion,\n  ZcashTransaction,\n} from './ZcashTransaction';\nimport { Network, PsbtTransaction, Signer } from '../../';\nimport { Psbt as PsbtBase } from 'bip174';\nimport * as types from 'bitcoinjs-lib/src/types';\nimport { ValidateSigFunction } from 'bitcoinjs-lib/src/psbt';\nimport { ProprietaryKeySubtype, PSBT_PROPRIETARY_IDENTIFIER, withUnsafeNonSegwit } from '../PsbtUtil';\nconst typeforce = require('typeforce');\n\nconst CONSENSUS_BRANCH_ID_KEY = Buffer.concat([\n  Buffer.of(0xfc),\n  Buffer.of(0x05),\n  Buffer.from(PSBT_PROPRIETARY_IDENTIFIER),\n  Buffer.of(ProprietaryKeySubtype.ZEC_CONSENSUS_BRANCH_ID),\n]);\n\nexport class ZcashPsbt extends UtxoPsbt<ZcashTransaction<bigint>> {\n  protected static transactionFromBuffer(buffer: Buffer, network: Network): ZcashTransaction<bigint> {\n    return ZcashTransaction.fromBuffer<bigint>(buffer, false, 'bigint', network);\n  }\n\n  static createPsbt(opts: PsbtOpts, data?: PsbtBase): ZcashPsbt {\n    return new ZcashPsbt(\n      opts,\n      data || new PsbtBase(new PsbtTransaction({ tx: new ZcashTransaction<bigint>(opts.network) }))\n    );\n  }\n\n  /**\n   * In version < 5 of Zcash transactions, the consensus branch ID is not serialized in the transaction\n   * whereas in version 5 it is. If the transaction is less than a version 5, set the consensus branch id\n   * in the global map in the psbt. If it is a version 5 transaction, throw an error if the consensus\n   * branch id is set in the psbt (because it should be on the transaction already).\n   * @param buffer Psbt buffer\n   * @param opts options\n   */\n  static fromBuffer(buffer: Buffer, opts: PsbtOpts): UtxoPsbt<ZcashTransaction<bigint>> {\n    const psbt = super.fromBuffer(buffer, opts) as ZcashPsbt;\n\n    // Read `consensusBranchId` from the global-map\n    let consensusBranchId: number | undefined = undefined;\n    psbt.data.globalMap.unknownKeyVals?.forEach(({ key, value }, i) => {\n      if (key.equals(CONSENSUS_BRANCH_ID_KEY)) {\n        consensusBranchId = value.readUint32LE();\n      }\n    });\n    switch (psbt.tx.version) {\n      case 4:\n      case ZcashTransaction.VERSION4_BRANCH_CANOPY:\n      case ZcashTransaction.VERSION4_BRANCH_NU5:\n        if (!consensusBranchId || !psbt.data.globalMap.unknownKeyVals) {\n          throw new Error('Could not find consensus branch id on psbt for version 4 Zcash transaction');\n        }\n        psbt.tx.consensusBranchId = consensusBranchId;\n        psbt.data.globalMap.unknownKeyVals = psbt.data.globalMap.unknownKeyVals.filter(\n          ({ key }) => key !== CONSENSUS_BRANCH_ID_KEY\n        );\n\n        // Delete consensusBranchId from globalMap so that if we were to serialize the psbt again\n        // we would not add a duplicate key into the global map\n        psbt.data.globalMap.unknownKeyVals.pop();\n        return psbt;\n      case 5:\n      case ZcashTransaction.VERSION5_BRANCH_NU5:\n        if (consensusBranchId) {\n          throw new Error('Found consensus branch id in psbt global-map for version 5 Zcash transaction');\n        }\n        return psbt;\n      default:\n        throw new Error(`Unsupported transaction version ${psbt.tx.version}`);\n    }\n  }\n\n  /**\n   * If it is a version 4 transaction, add the consensus branch id to\n   * the global map. If it is a version 5 transaction, just return the\n   * buffer because the consensus branch id is already serialized in\n   * the transaction.\n   */\n  toBuffer(): Buffer {\n    if (this.tx.version === 5 || this.tx.version >= ZcashTransaction.VERSION5_BRANCH_NU5) {\n      return super.toBuffer();\n    }\n    const value = Buffer.alloc(4);\n    value.writeUint32LE(this.tx.consensusBranchId);\n    this.addUnknownKeyValToGlobal({ key: CONSENSUS_BRANCH_ID_KEY, value });\n    if (!this.data.globalMap.unknownKeyVals) {\n      throw new Error('Failed adding consensus branch id to unknownKeyVals');\n    }\n    const buff = super.toBuffer();\n    this.data.globalMap.unknownKeyVals.pop();\n    return buff;\n  }\n\n  setVersion(version: number, overwinter = true): this {\n    typeforce(types.UInt32, version);\n    this.tx.overwintered = overwinter ? 1 : 0;\n    this.tx.version = version;\n    return this;\n  }\n\n  setDefaultsForVersion(network: Network, version: number): void {\n    switch (version) {\n      case 4:\n      case ZcashTransaction.VERSION4_BRANCH_CANOPY:\n      case ZcashTransaction.VERSION4_BRANCH_NU5:\n      case ZcashTransaction.VERSION4_BRANCH_NU6:\n        this.setVersion(4);\n        break;\n      case 5:\n      case ZcashTransaction.VERSION5_BRANCH_NU5:\n      case ZcashTransaction.VERSION5_BRANCH_NU6:\n        this.setVersion(5);\n        break;\n      default:\n        throw new Error(`invalid version ${version}`);\n    }\n\n    this.tx.versionGroupId = getDefaultVersionGroupIdForVersion(version);\n    this.tx.consensusBranchId = getDefaultConsensusBranchIdForVersion(network, version);\n  }\n\n  // For Zcash transactions, we do not have to have non-witness UTXO data for non-segwit\n  // transactions because zcash hashes the value directly. Thus, it is unnecessary to have\n  // the previous transaction hash on the unspent.\n  signInput(inputIndex: number, keyPair: Signer, sighashTypes?: number[]): this {\n    return withUnsafeNonSegwit(this, super.signInput.bind(this, inputIndex, keyPair, sighashTypes));\n  }\n\n  validateSignaturesOfInput(inputIndex: number, validator: ValidateSigFunction, pubkey?: Buffer): boolean {\n    return withUnsafeNonSegwit(this, super.validateSignaturesOfInput.bind(this, inputIndex, validator, pubkey));\n  }\n\n  private setPropertyCheckSignatures(propName: keyof ZcashTransaction<bigint>, value: unknown) {\n    if (this.tx[propName] === value) {\n      return;\n    }\n    this.checkForSignatures(propName);\n    this.tx[propName] = value as any;\n  }\n\n  setConsensusBranchId(consensusBranchId: number): void {\n    typeforce(types.UInt32, consensusBranchId);\n    this.setPropertyCheckSignatures('consensusBranchId', consensusBranchId);\n  }\n\n  setVersionGroupId(versionGroupId: number): void {\n    typeforce(types.UInt32, versionGroupId);\n    this.setPropertyCheckSignatures('versionGroupId', versionGroupId);\n  }\n\n  setExpiryHeight(expiryHeight: number): void {\n    typeforce(types.UInt32, expiryHeight);\n    this.setPropertyCheckSignatures('expiryHeight', expiryHeight);\n  }\n}\n"]}
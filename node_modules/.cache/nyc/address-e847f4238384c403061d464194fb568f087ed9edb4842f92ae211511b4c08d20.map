{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/bitcoincash/address.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/bitgo/bitcoincash/address.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Wrapper around `cashaddress` library.\n *\n * Performs some address sanitation:\n * - add prefix if missing\n * - normalize to lower-case\n * - reject mixed-case\n *\n * Based on these documents\n *\n * - https://github.com/bitcoincashorg/bitcoincash.org/blob/master/spec/cashaddr.md\n * - https://www.bitcoinabc.org/cashaddr/\n */\nimport * as cashaddress from 'cashaddress';\nimport * as bitcoinjs from 'bitcoinjs-lib';\nimport { getNetworkName, isBitcoinCash, isECash, Network, networks } from '../../networks';\nimport { AddressFormat } from '../../addressFormat';\n\n/**\n * @param name\n * @param output\n * @return the encoded pubkeyhash or scripthash\n */\nfunction getHashFromOutputScript(name: string, output: Buffer): Buffer | undefined {\n  type PaymentFunc = ({ output }: { output: Buffer }) => bitcoinjs.Payment;\n  const func = (bitcoinjs.payments as unknown as Record<string, PaymentFunc>)[name];\n  if (!func) {\n    throw new Error(`no payment with name ${name}`);\n  }\n  try {\n    return func({ output }).hash;\n  } catch (e) {\n    return undefined;\n  }\n}\n\n/**\n * @param network\n * @return network-specific cashaddr prefix\n */\nexport function getPrefix(network: Network): string {\n  switch (network) {\n    case networks.bitcoincash:\n      return 'bitcoincash';\n    case networks.bitcoincashTestnet:\n      return 'bchtest';\n    case networks.ecash:\n      return 'ecash';\n    case networks.ecashTest:\n      return 'ectest';\n    default:\n      throw new Error(`unsupported prefix for ${getNetworkName(network)}`);\n  }\n}\n\n/**\n * @param outputScript\n * @param network\n * @return outputScript encoded as cashaddr (prefixed, lowercase)\n */\nexport function fromOutputScriptToCashAddress(outputScript: Buffer, network: Network): string {\n  if (!isBitcoinCash(network) && !isECash(network)) {\n    throw new Error(`invalid network`);\n  }\n  for (const [paymentName, scriptType] of [\n    ['p2pkh', 'pubkeyhash'],\n    ['p2sh', 'scripthash'],\n  ]) {\n    const hash = getHashFromOutputScript(paymentName, outputScript);\n    if (hash) {\n      return cashaddress.encode(getPrefix(network), scriptType as cashaddress.ScriptType, hash);\n    }\n  }\n  throw new Error(`could not determine hash for outputScript`);\n}\n\n/**\n * @param address - Accepts addresses with and without prefix. Accepts all-lowercase and all-uppercase addresses. Rejects mixed-case addresses.\n * @param network\n * @return decoded output script\n */\nexport function toOutputScriptFromCashAddress(address: string, network: Network): Buffer {\n  if (!isBitcoinCash(network) && !isECash(network)) {\n    throw new Error(`invalid network`);\n  }\n  if (address === address.toUpperCase()) {\n    address = address.toLowerCase();\n  }\n  if (address !== address.toLowerCase()) {\n    throw new Error(`mixed-case addresses not allowed`);\n  }\n  if (!address.startsWith(getPrefix(network) + ':')) {\n    address = `${getPrefix(network)}:${address}`;\n  }\n  const decoded = cashaddress.decode(address);\n  let outputScript: Buffer | undefined;\n  switch (decoded.version) {\n    case 'scripthash':\n      outputScript = bitcoinjs.payments.p2sh({ hash: decoded.hash }).output;\n      break;\n    case 'pubkeyhash':\n      outputScript = bitcoinjs.payments.p2pkh({ hash: decoded.hash }).output;\n      break;\n    default:\n      throw new Error(`unknown version ${decoded.version}`);\n  }\n  if (!outputScript) {\n    throw new Error(`could not determine output script`);\n  }\n  return outputScript;\n}\n\n/**\n * @param outputScript\n * @param format\n * @param network\n * @return address in specified format\n */\nexport function fromOutputScriptWithFormat(outputScript: Buffer, format: AddressFormat, network: Network): string {\n  if (!isBitcoinCash(network) && !isECash(network)) {\n    throw new Error(`invalid network`);\n  }\n\n  if (format === 'cashaddr') {\n    return fromOutputScriptToCashAddress(outputScript, network);\n  }\n\n  if (format === 'default') {\n    return bitcoinjs.address.fromOutputScript(outputScript, network as bitcoinjs.Network);\n  }\n\n  throw new Error(`invalid format`);\n}\n\n/**\n * @param address\n * @param format\n * @param network\n * @return output script from address in specified format\n */\nexport function toOutputScriptWithFormat(address: string, format: AddressFormat, network: Network): Buffer {\n  if (!isBitcoinCash(network) && !isECash(network)) {\n    throw new Error(`invalid network`);\n  }\n\n  if (format === 'cashaddr') {\n    return toOutputScriptFromCashAddress(address, network);\n  }\n\n  if (format === 'default') {\n    return bitcoinjs.address.toOutputScript(address, network as bitcoinjs.Network);\n  }\n\n  throw new Error(`invalid format`);\n}\n"]}
{"version":3,"file":"/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/payments/p2tr_ns.ts","sources":["/Users/qroc/Code/hapi/chaindefuser/utxo-lib/src/payments/p2tr_ns.ts"],"names":[],"mappings":"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","sourcesContent":["import { networks } from '../networks';\nimport { script as bscript, Payment, PaymentOpts, Stack, lazy } from 'bitcoinjs-lib';\n\nconst OPS = bscript.OPS;\nconst typef = require('typeforce');\n\nconst BITCOIN_NETWORK = networks.bitcoin;\n\nfunction stacksEqual(a: Buffer[], b: Buffer[]): boolean {\n  if (a.length !== b.length) return false;\n\n  return a.every((x, i) => {\n    return x.equals(b[i]);\n  });\n}\n\n// input: [signatures ...]\n// output: [pubKeys[0:n-1] OP_CHECKSIGVERIFY] pubKeys[n-1] OP_CHECKSIG\nexport function p2tr_ns(a: Payment, opts?: PaymentOpts): Payment {\n  if (!a.input && !a.output && !(a.pubkeys && a.pubkeys.length) && !a.signatures) {\n    throw new TypeError('Not enough data');\n  }\n  opts = Object.assign({ validate: true }, opts || {});\n\n  if (!opts.eccLib) throw new Error('ECC Library is required for p2tr_ns.');\n  const ecc = opts.eccLib;\n\n  function isAcceptableSignature(x: Buffer | number): boolean {\n    if (Buffer.isBuffer(x)) {\n      return (\n        // empty signatures may be represented as empty buffers\n        (opts && opts.allowIncomplete && x.length === 0) || bscript.isCanonicalSchnorrSignature(x)\n      );\n    }\n    return !!(opts && opts.allowIncomplete && x === OPS.OP_0);\n  }\n\n  typef(\n    {\n      network: typef.maybe(typef.Object),\n      output: typef.maybe(typef.Buffer),\n      pubkeys: typef.maybe(typef.arrayOf(ecc.isXOnlyPoint)),\n\n      signatures: typef.maybe(typef.arrayOf(isAcceptableSignature)),\n      input: typef.maybe(typef.Buffer),\n    },\n    a\n  );\n\n  const network = a.network || BITCOIN_NETWORK;\n  const o: Payment = { network };\n\n  const _chunks = lazy.value(() => {\n    if (!a.output) return;\n    return bscript.decompile(a.output) as Stack;\n  });\n\n  lazy.prop(o, 'output', () => {\n    if (!a.pubkeys) return;\n    return bscript.compile(\n      ([] as Stack).concat(\n        ...a.pubkeys.map((pk, i, pks) => [pk, i === pks.length - 1 ? OPS.OP_CHECKSIG : OPS.OP_CHECKSIGVERIFY])\n      )\n    );\n  });\n  lazy.prop(o, 'n', () => {\n    if (!o.pubkeys) return;\n    return o.pubkeys.length;\n  });\n  lazy.prop(o, 'pubkeys', () => {\n    const chunks = _chunks();\n    if (!chunks) return;\n    return chunks.filter((_, index) => index % 2 === 0) as Buffer[];\n  });\n  lazy.prop(o, 'signatures', () => {\n    if (!a.input) return;\n    return bscript.decompile(a.input)?.reverse();\n  });\n  lazy.prop(o, 'input', () => {\n    if (!a.signatures) return;\n    return bscript.compile([...a.signatures].reverse());\n  });\n  lazy.prop(o, 'witness', () => {\n    if (!o.input) return;\n    return [];\n  });\n  lazy.prop(o, 'name', () => {\n    if (!o.n) return;\n    return `p2tr_ns(${o.n})`;\n  });\n\n  // extended validation\n  if (opts.validate) {\n    const chunks = _chunks();\n    if (chunks) {\n      if (chunks[chunks.length - 1] !== OPS.OP_CHECKSIG) {\n        throw new TypeError('Output ends with unexpected opcode');\n      }\n      if (\n        chunks\n          .filter((_, index) => index % 2 === 1)\n          .slice(0, -1)\n          .some((op) => op !== OPS.OP_CHECKSIGVERIFY)\n      ) {\n        throw new TypeError('Output contains unexpected opcode');\n      }\n      if (o.n! > 16 || o.n !== chunks.length / 2) {\n        throw new TypeError('Output contains too many pubkeys');\n      }\n      if (o.pubkeys!.some((x) => !ecc.isXOnlyPoint(x))) {\n        throw new TypeError('Output contains invalid pubkey(s)');\n      }\n\n      if (a.pubkeys && !stacksEqual(a.pubkeys, o.pubkeys!)) {\n        throw new TypeError('Pubkeys mismatch');\n      }\n    }\n\n    if (a.pubkeys && a.pubkeys.length) {\n      o.n = a.pubkeys.length;\n    }\n\n    if (a.signatures && o.n) {\n      if (a.signatures.length < o.n) {\n        throw new TypeError('Not enough signatures provided');\n      }\n      if (a.signatures.length > o.n) {\n        throw new TypeError('Too many signatures provided');\n      }\n    }\n\n    if (a.input) {\n      if (!o.signatures!.every(isAcceptableSignature)) {\n        throw new TypeError('Input has invalid signature(s)');\n      }\n\n      if (a.signatures && !stacksEqual(a.signatures, o.signatures!)) {\n        throw new TypeError('Signature mismatch');\n      }\n      if (o.n !== o.signatures!.length) {\n        throw new TypeError(`Signature count mismatch (n: ${o.n}, signatures.length: ${o.signatures!.length}`);\n      }\n    }\n  }\n\n  return Object.assign(o, a);\n}\n"]}